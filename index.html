<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2c1f14">
<title>WORN</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--ink:#1a1410;--parchment:#f0ead8;--warm-dark:#2c1f14;--rust:#8b3a2a;--dusty-rose:#c4907a;--aged-gold:#b8963e;--sage:#7a8c6e;--cream:#ede5d0;--muted:#6b5a4a;--jewel:#5c4a7a;--jewel-light:#9b84c4;}*{margin:0;padding:0;box-sizing:border-box;}body{background:var(--warm-dark);color:var(--parchment);font-family:'Libre Baskerville',serif;min-height:100vh;overflow-x:hidden;}body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.07'/%3E%3C/svg%3E");opacity:0.4;pointer-events:none;z-index:1000;}.header{text-align:center;padding:2.5rem 1rem 1rem;position:relative;border-bottom:1px solid rgba(184,150,62,0.3);}.header h1{font-family:'Cormorant Garamond',serif;font-size:clamp(3rem,8vw,5.5rem);font-weight:300;letter-spacing:0.5em;text-transform:uppercase;line-height:1;}.tagline{font-family:'Courier Prime',monospace;font-size:0.65rem;letter-spacing:0.3em;color:var(--aged-gold);text-transform:uppercase;margin-top:0.5rem;opacity:0.8;}.weather-pill{position:absolute;top:1.5rem;right:1.2rem;font-family:'Courier Prime',monospace;font-size:0.62rem;letter-spacing:0.12em;color:var(--dusty-rose);text-align:right;line-height:1.6;}.nav{display:flex;border-bottom:1px solid rgba(184,150,62,0.3);overflow-x:auto;scrollbar-width:none;}.nav::-webkit-scrollbar{display:none;}.nav-btn{font-family:'Courier Prime',monospace;font-size:0.56rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;padding:0.9rem 1.1rem;cursor:pointer;transition:all 0.3s;white-space:nowrap;flex-shrink:0;}.nav-btn:hover{color:var(--parchment);}.nav-btn.active{color:var(--aged-gold);border-bottom-color:var(--aged-gold);}.section{display:none;padding:1.5rem 1rem 3rem;max-width:960px;margin:0 auto;}.section.active{display:block;animation:fadeIn 0.35s ease;}@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}.sec-title{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;font-style:italic;margin-bottom:0.2rem;}.sec-sub{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.2em;color:var(--muted);text-transform:uppercase;margin-bottom:1.4rem;}.btn-p{font-family:'Courier Prime',monospace;font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;background:var(--rust);color:var(--parchment);border:none;padding:0.7rem 1.4rem;cursor:pointer;transition:all 0.2s;}.btn-p:hover{background:var(--dusty-rose);color:var(--ink);}.btn-p:disabled{opacity:0.4;cursor:not-allowed;}.btn-s{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;background:transparent;color:var(--aged-gold);border:1px solid rgba(184,150,62,0.4);padding:0.5rem 1rem;cursor:pointer;transition:all 0.2s;}.btn-s:hover{background:rgba(184,150,62,0.1);}.btn-g{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;background:transparent;color:var(--muted);border:1px solid rgba(107,90,74,0.4);padding:0.4rem 0.8rem;cursor:pointer;transition:all 0.2s;}.btn-g:hover{color:var(--parchment);border-color:var(--muted);}.fg{margin-bottom:1.1rem;}.fl{display:block;font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--aged-gold);margin-bottom:0.35rem;}input[type=text],input[type=number],input[type=password],textarea,select{width:100%;background:rgba(26,20,16,0.6);border:1px solid rgba(107,90,74,0.4);color:var(--parchment);font-family:'Libre Baskerville',serif;font-size:0.84rem;padding:0.55rem 0.75rem;outline:none;transition:border-color 0.2s;-webkit-appearance:none;border-radius:0;}input:focus,textarea:focus,select:focus{border-color:var(--aged-gold);}textarea{min-height:70px;resize:vertical;}select option{background:var(--warm-dark);}.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.8rem;}@media(max-width:520px){.g2,.g3{grid-template-columns:1fr;}}.tag-group{display:flex;flex-wrap:wrap;gap:0.35rem;margin-top:0.35rem;}.tp{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.28rem 0.65rem;border:1px solid rgba(107,90,74,0.5);color:var(--muted);cursor:pointer;transition:all 0.2s;background:transparent;}.tp:hover{color:var(--parchment);border-color:var(--muted);}.tp.on{background:var(--rust);color:var(--parchment);border-color:var(--rust);}.ctag-wrap{display:flex;gap:0.4rem;margin-top:0.5rem;align-items:center;}.ctag-wrap input{flex:1;font-size:0.78rem;}.ctags{display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.4rem;}.ctag{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.1em;padding:0.25rem 0.55rem;background:rgba(92,74,122,0.25);color:var(--jewel-light);border:1px solid rgba(92,74,122,0.4);display:inline-flex;align-items:center;gap:0.3rem;}.ctx{cursor:pointer;opacity:0.6;font-size:0.75rem;}.ctx:hover{opacity:1;}.photo-strip{display:flex;gap:0.5rem;margin-bottom:0.5rem;}.pslot{flex:1;min-width:0;aspect-ratio:2/3;background:rgba(26,20,16,0.6);border:1px dashed rgba(107,90,74,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;transition:border-color 0.2s;}.pslot:hover{border-color:var(--aged-gold);}.pslot input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;padding:0;border:none;background:transparent;}.pslot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}.pslot .slbl{font-family:'Courier Prime',monospace;font-size:0.46rem;letter-spacing:0.09em;text-transform:uppercase;color:var(--muted);text-align:center;padding:0.3rem;line-height:1.5;pointer-events:none;z-index:1;position:relative;}.pslot .sico{font-size:1.1rem;margin-bottom:0.15rem;pointer-events:none;z-index:1;position:relative;}.pslot.hi .slbl,.pslot.hi .sico{opacity:0;}.panel{background:rgba(26,20,16,0.5);border:1px solid rgba(107,90,74,0.3);padding:1.4rem;margin-bottom:1.3rem;}.ptitle{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--aged-gold);margin-bottom:1rem;padding-bottom:0.45rem;border-bottom:1px solid rgba(184,150,62,0.2);}.ptitle-lg{font-family:'Cormorant Garamond',serif;font-size:1.25rem;font-weight:300;font-style:italic;color:var(--parchment);margin-bottom:0.9rem;}.filter-bar{display:flex;flex-wrap:wrap;gap:0.35rem;margin-bottom:1rem;}.fbtn{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.3rem 0.7rem;border:1px solid rgba(107,90,74,0.4);color:var(--muted);background:transparent;cursor:pointer;transition:all 0.2s;}.fbtn:hover,.fbtn.on{background:rgba(184,150,62,0.15);color:var(--aged-gold);border-color:var(--aged-gold);}.search-bar{display:flex;gap:0.5rem;margin-bottom:0.8rem;}.search-bar input{flex:1;}.closet-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:0.9rem;margin-top:1rem;}.ccard{background:rgba(26,20,16,0.7);border:1px solid rgba(107,90,74,0.3);cursor:pointer;transition:all 0.2s;overflow:hidden;}.ccard:hover{border-color:var(--aged-gold);transform:translateY(-2px);}.ccard-img{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;background:rgba(44,31,20,0.8);}.ccard-ph{width:100%;aspect-ratio:3/4;display:flex;align-items:center;justify-content:center;background:rgba(44,31,20,0.6);color:var(--muted);font-size:1.8rem;}.ccard-info{padding:0.45rem 0.5rem;}.ccard-name{font-family:'Cormorant Garamond',serif;font-size:0.82rem;color:var(--parchment);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:0.2rem;}.ccard-tags{display:flex;flex-wrap:wrap;gap:0.15rem;}.mt{font-family:'Courier Prime',monospace;font-size:0.42rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.12rem 0.3rem;background:rgba(107,90,74,0.3);color:var(--muted);}.mt.anc{background:rgba(139,58,42,0.35);color:var(--dusty-rose);}.mt.cor{background:rgba(122,140,110,0.25);color:var(--sage);}.mt.cus{background:rgba(92,74,122,0.25);color:var(--jewel-light);}.mt.occ{background:rgba(184,150,62,0.15);color:var(--aged-gold);}.pole-row{display:flex;align-items:center;gap:0.8rem;margin-bottom:0.7rem;}.plbl{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.09em;text-transform:uppercase;width:72px;text-align:right;color:var(--parchment);flex-shrink:0;}.plbl.r{text-align:left;}.pole-slider{flex:1;-webkit-appearance:none;height:2px;background:linear-gradient(to right,var(--dusty-rose),var(--ink),var(--sage));outline:none;border:none;padding:0;cursor:pointer;}.pole-slider::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--aged-gold);border-radius:50%;cursor:pointer;border:2px solid var(--warm-dark);}.quiz-q{margin-bottom:1.2rem;}.quiz-qt{font-family:'Cormorant Garamond',serif;font-size:0.98rem;font-style:italic;color:var(--cream);margin-bottom:0.5rem;}.qopts{display:flex;flex-wrap:wrap;gap:0.4rem;}.qo{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.35rem 0.75rem;border:1px solid rgba(107,90,74,0.4);color:var(--muted);cursor:pointer;transition:all 0.2s;background:transparent;}.qo:hover{color:var(--parchment);border-color:var(--muted);}.qo.on{background:rgba(139,58,42,0.3);color:var(--dusty-rose);border-color:var(--rust);}.meas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.7rem;}.mf{display:flex;flex-direction:column;gap:0.3rem;}.mf label{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--aged-gold);}.prof-photo-slot{width:110px;flex-shrink:0;aspect-ratio:2/3;background:rgba(26,20,16,0.6);border:1px dashed rgba(107,90,74,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;transition:border-color 0.2s;}.prof-photo-slot:hover{border-color:var(--aged-gold);}.prof-photo-slot input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;border:none;background:transparent;}.prof-photo-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}.mood-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.4rem;margin-top:0.4rem;}.mbtn{font-family:'Cormorant Garamond',serif;font-size:0.88rem;font-style:italic;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.55rem 0.3rem;cursor:pointer;transition:all 0.2s;text-align:center;}.mbtn:hover,.mbtn.on{background:rgba(139,58,42,0.25);color:var(--parchment);border-color:var(--dusty-rose);}.intent-row{display:flex;gap:0.4rem;margin-top:0.4rem;}.ibtn{flex:1;font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.55rem 0.3rem;cursor:pointer;transition:all 0.2s;text-align:center;}.ibtn:hover,.ibtn.on{border-color:var(--aged-gold);color:var(--aged-gold);background:rgba(184,150,62,0.08);}.outfit-out{background:rgba(26,20,16,0.7);border:1px solid rgba(184,150,62,0.3);padding:1.4rem;display:none;animation:fadeIn 0.5s ease;}.outfit-out.show{display:block;}.out-name{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;font-style:italic;color:var(--aged-gold);margin-bottom:0.3rem;}.out-expl{font-family:'Libre Baskerville',serif;font-size:0.8rem;line-height:1.75;color:var(--cream);margin:0.9rem 0;font-style:italic;}.flat-lay{display:flex;flex-wrap:wrap;gap:0.6rem;padding:1rem;background:rgba(44,31,20,0.35);margin:0.8rem 0;justify-content:center;min-height:70px;align-items:center;}.fl-piece{text-align:center;}.fl-piece img{width:60px;height:78px;object-fit:cover;border:1px solid rgba(107,90,74,0.35);}.fl-piece span{display:block;font-family:'Courier Prime',monospace;font-size:0.42rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--rust);margin-top:0.2rem;}.fl-piece-ico{font-size:1.8rem;display:block;}.piece-row{display:flex;align-items:center;gap:0.7rem;padding:0.5rem 0;border-bottom:1px solid rgba(107,90,74,0.18);}.p-role{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--rust);width:80px;flex-shrink:0;}.p-name{font-family:'Cormorant Garamond',serif;font-size:0.98rem;color:var(--parchment);}.thrift-box{background:rgba(122,140,110,0.12);border:1px solid rgba(122,140,110,0.28);border-left:3px solid var(--sage);padding:0.75rem 1rem;margin-top:0.9rem;font-family:'Libre Baskerville',serif;font-size:0.78rem;font-style:italic;color:var(--cream);line-height:1.6;}.thrift-box::before{content:'‚Äî thrift radar';display:block;font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--sage);margin-bottom:0.35rem;font-style:normal;}.spinner{text-align:center;padding:2rem;font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--muted);display:none;}.spinner.show{display:block;}@keyframes pulse{0%,100%{opacity:0.3;}50%{opacity:1;}}.dots{animation:pulse 1.4s ease-in-out infinite;}.looks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:1rem;margin-top:1rem;}.lcard{background:rgba(26,20,16,0.7);border:1px solid rgba(107,90,74,0.3);overflow:hidden;}.lcard-img{width:100%;aspect-ratio:2/3;object-fit:cover;}.lcard-ph{width:100%;aspect-ratio:2/3;display:flex;align-items:center;justify-content:center;background:rgba(44,31,20,0.6);color:var(--muted);font-size:2.5rem;}.lcard-info{padding:0.75rem;}.lcard-name{font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--aged-gold);margin-bottom:0.2rem;}.lcard-date{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.4rem;}.rtag{font-family:'Courier Prime',monospace;font-size:0.46rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.18rem 0.38rem;}.rtag.win{background:rgba(122,140,110,0.28);color:var(--sage);}.rtag.miss{background:rgba(139,58,42,0.28);color:var(--dusty-rose);}.rtag.neu{background:rgba(107,90,74,0.28);color:var(--muted);}.lcard-notes{font-family:'Libre Baskerville',serif;font-size:0.7rem;color:var(--muted);font-style:italic;line-height:1.5;margin-top:0.4rem;}.react-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.35rem;margin-top:0.4rem;}.rbtn{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.09em;text-transform:uppercase;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.42rem;cursor:pointer;transition:all 0.2s;text-align:center;}.rbtn.win.on{background:rgba(122,140,110,0.28);color:var(--sage);border-color:var(--sage);}.rbtn.miss.on{background:rgba(139,58,42,0.28);color:var(--dusty-rose);border-color:var(--dusty-rose);}.rbtn.neu.on{background:rgba(107,90,74,0.28);color:var(--parchment);border-color:var(--muted);}.traj-box{background:rgba(122,140,110,0.08);border:1px solid rgba(122,140,110,0.2);border-left:3px solid var(--sage);padding:0.75rem 1rem;margin-top:1rem;}.traj-lbl{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--sage);margin-bottom:0.25rem;}.traj-txt{font-family:'Cormorant Garamond',serif;font-size:0.9rem;font-style:italic;color:var(--cream);line-height:1.5;}.empty{text-align:center;padding:2.5rem 1rem;grid-column:1/-1;}.empty-ico{font-size:2.5rem;margin-bottom:0.8rem;opacity:0.35;}.empty-txt{font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--muted);}.modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,20,16,0.96);z-index:500;overflow-y:auto;padding:1.5rem 1rem;}.modal-overlay.open{display:flex;align-items:flex-start;justify-content:center;}.modal{background:var(--warm-dark);border:1px solid rgba(107,90,74,0.4);max-width:520px;width:100%;padding:1.4rem;animation:fadeIn 0.3s ease;}.modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.7rem;border-bottom:1px solid rgba(107,90,74,0.3);}.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.25rem;font-style:italic;color:var(--parchment);}.modal-x{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;font-family:'Courier Prime',monospace;padding:0.2rem 0.5rem;}.modal-x:hover{color:var(--parchment);}hr.d{border:none;height:1px;background:rgba(107,90,74,0.28);margin:1.2rem 0;}.row-btns{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;}.backup-bar{background:rgba(26,20,16,0.8);border-bottom:1px solid rgba(107,90,74,0.3);padding:0.5rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;}.backup-status{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.1em;color:var(--muted);}.backup-status.fresh{color:var(--sage);}.backup-btns{display:flex;gap:0.4rem;}.api-banner{background:rgba(139,58,42,0.2);border:1px solid rgba(139,58,42,0.4);padding:0.8rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.8rem;flex-wrap:wrap;}.api-banner p{font-family:'Courier Prime',monospace;font-size:0.55rem;letter-spacing:0.1em;color:var(--dusty-rose);flex:1;}.api-banner.hidden{display:none;}
</style>
</head>
<body>
<div class="backup-bar">
  <span class="backup-status" id="backupStatus">‚úì data protected</span>
  <div class="backup-btns">
    <button class="btn-g" onclick="manualExport()" style="font-size:0.5rem;padding:0.3rem 0.6rem;">‚¨á Export</button>
    <label class="btn-g" style="font-size:0.5rem;padding:0.3rem 0.6rem;cursor:pointer;">‚¨Ü Import<input type="file" accept=".json" onchange="importData(this)" style="display:none;"></label>
    <button class="btn-g" onclick="showApiModal()" style="font-size:0.5rem;padding:0.3rem 0.6rem;">üîë Key</button>
  </div>
</div>
<div class="header">
  <div class="weather-pill" id="weatherDisplay">‚Äî</div>
  <h1>WORN</h1>
  <p class="tagline">your closet. your logic. your story.</p>
</div>
<nav class="nav">
  <button class="nav-btn active" onclick="nav('closet',this)">Closet</button>
  <button class="nav-btn" onclick="nav('profile',this)">My Profile</button>
  <button class="nav-btn" onclick="nav('dressme',this)">Dress Me</button>
  <button class="nav-btn" onclick="nav('looks',this)">My Looks</button>
</nav>
<div class="api-banner hidden" id="apiBanner">
  <p>Dress Me needs an API key.</p>
  <button class="btn-g" onclick="showApiModal()" style="font-size:0.5rem;">Add Key ‚Üí</button>
</div>

<div class="section active" id="closet">
  <p class="sec-title">The Closet</p>
  <p class="sec-sub">every piece cataloged</p>
  <div class="panel">
    <p class="ptitle-lg">Add a piece</p>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">Name</label><input type="text" id="iName" placeholder="rust silk blouse..."></div>
        <div class="fg"><label class="fl">Category</label>
          <select id="iCat" onchange="updateDynTags()">
            <option value="">‚Äî select ‚Äî</option>
            <optgroup label="Clothing"><option>Top</option><option>Bottom</option><option>Dress</option><option>Outerwear</option><option>Modesty Layer</option></optgroup>
            <optgroup label="Footwear"><option>Shoes</option><option>Boots</option><option>Sandals</option><option>Sneakers</option></optgroup>
            <optgroup label="Jewelry"><option>Necklace</option><option>Earrings</option><option>Ring</option><option>Bracelet</option><option>Anklet</option><option>Body Jewelry</option><option>Hair Jewelry</option></optgroup>
            <optgroup label="Accessories"><option>Belt</option><option>Bag</option><option>Hat</option><option>Scarf</option><option>Socks / Tights</option><option>Sunglasses</option><option>Other</option></optgroup>
          </select>
        </div>
        <div class="fg"><label class="fl">Color(s)</label><input type="text" id="iColor" placeholder="rust, cream..."></div>
        <div class="fg"><label class="fl">Source</label><input type="text" id="iSource" placeholder="DI, Poshmark..."></div>
      </div>
      <div>
        <label class="fl">Photos</label>
        <div class="photo-strip" id="photoStrip"></div>
        <p id="photoHint" style="font-family:'Courier Prime',monospace;font-size:0.48rem;color:var(--muted);margin-top:0.3rem;">select category first</p>
      </div>
    </div>
    <div id="dynTags"></div>
    <div class="fg">
      <label class="fl">Occasions</label>
      <div class="tag-group" id="tOcc"><button class="tp" onclick="tog(this)">Everyday</button><button class="tp" onclick="tog(this)">Casual</button><button class="tp" onclick="tog(this)">Work</button><button class="tp" onclick="tog(this)">Church</button><button class="tp" onclick="tog(this)">Date</button><button class="tp" onclick="tog(this)">Party</button><button class="tp" onclick="tog(this)">Special</button><button class="tp" onclick="tog(this)">Sleep</button><button class="tp" onclick="tog(this)">Active</button><button class="tp" onclick="tog(this)">Winter</button></div>
    </div>
    <div class="fg">
      <label class="fl">Custom tags</label>
      <div class="ctag-wrap"><input type="text" id="ctagIn" placeholder="#witchy #thrifted-DI..." onkeydown="if(event.key==='Enter'){addCtag();event.preventDefault();}"><button class="btn-g" onclick="addCtag()">+</button></div>
      <div class="ctags" id="ctagDisplay"></div>
    </div>
    <div class="fg"><label class="fl">Notes</label><textarea id="iNotes" placeholder="fits loose, love the buttons..."></textarea></div>
    <div class="row-btns"><button class="btn-p" onclick="addItem()">Add to Closet</button><button class="btn-g" onclick="clearForm()">Clear</button></div>
  </div>
  <div class="search-bar"><input type="text" id="searchIn" placeholder="search..." oninput="renderCloset()"></div>
  <div class="filter-bar">
    <button class="fbtn on" onclick="setF('all',this)">All</button>
    <button class="fbtn" onclick="setF('clothing',this)">Clothing</button>
    <button class="fbtn" onclick="setF('footwear',this)">Footwear</button>
    <button class="fbtn" onclick="setF('jewelry',this)">Jewelry</button>
    <button class="fbtn" onclick="setF('accessories',this)">Accessories</button>
  </div>
  <div class="closet-grid" id="closetGrid"></div>
</div>

<div class="section" id="profile">
  <p class="sec-title">My Profile</p>
  <p class="sec-sub">living document</p>
  <div class="panel">
    <p class="ptitle">reference photo</p>
    <div style="display:flex;gap:1rem;">
      <div class="prof-photo-slot" id="profPhotoSlot">
        <input type="file" accept="image/*" onchange="setProfilePhoto(this)">
        <span style="font-size:1.5rem;position:relative;z-index:1;">ü™û</span>
        <span style="font-family:'Courier Prime',monospace;font-size:0.46rem;color:var(--muted);text-align:center;position:relative;z-index:1;">white tee +<br>bike shorts</span>
      </div>
      <p style="flex:1;font-size:0.78rem;font-style:italic;color:var(--muted);line-height:1.7;">Your baseline for all on-body photos</p>
    </div>
  </div>
  <div class="panel">
    <p class="ptitle">style poles</p>
    <div class="pole-row"><span class="plbl">Soft</span><input type="range" class="pole-slider" id="pSS" min="0" max="100" value="35"><span class="plbl r">Structured</span></div>
    <div class="pole-row"><span class="plbl">Romantic</span><input type="range" class="pole-slider" id="pRS" min="0" max="100" value="30"><span class="plbl r">Severe</span></div>
    <div class="pole-row"><span class="plbl">Vintage</span><input type="range" class="pole-slider" id="pVM" min="0" max="100" value="25"><span class="plbl r">Modern</span></div>
  </div>
  <div class="panel">
    <p class="ptitle">body</p>
    <div class="g2">
      <div class="fg"><label class="fl">Love showing</label><input type="text" id="bLove" placeholder="collarbone, waist..."></div>
      <div class="fg"><label class="fl">Prefer downplaying</label><input type="text" id="bDown" placeholder="hips..."></div>
    </div>
    <div class="fg"><label class="fl">Notes</label><textarea id="bNotes" placeholder="fit preferences, what doesn't work..."></textarea></div>
    <hr class="d">
    <div class="meas-grid">
      <div class="mf"><label>Height</label><input type="text" id="mH" placeholder='5&apos;6"'></div>
      <div class="mf"><label>Bust</label><input type="text" id="mB" placeholder='36"'></div>
      <div class="mf"><label>Waist</label><input type="text" id="mWa" placeholder='28"'></div>
      <div class="mf"><label>Hips</label><input type="text" id="mHi" placeholder='38"'></div>
    </div>
  </div>
  <div class="panel">
    <p class="ptitle">location</p>
    <div class="g2">
      <div class="fg"><label class="fl">City</label><input type="text" id="uLoc" placeholder="Salt Lake City"></div>
      <div class="fg"><label class="fl">Season</label><select id="uSea"><option>Winter</option><option>Spring</option><option>Summer</option><option>Fall</option></select></div>
    </div>
  </div>
  <div class="row-btns"><button class="btn-p" onclick="saveProfile()">Save Profile</button></div>
</div>

<div class="section" id="dressme">
  <p class="sec-title">Dress Me</p>
  <p class="sec-sub">head to toe</p>
  <div class="panel">
    <div class="fg"><label class="fl">What's my vibe today?</label>
      <div class="mood-grid"><button class="mbtn" onclick="selM(this)">stay home cozy</button><button class="mbtn" onclick="selM(this)">low effort cute</button><button class="mbtn" onclick="selM(this)">put together</button><button class="mbtn" onclick="selM(this)">going out</button><button class="mbtn" onclick="selM(this)">sexy</button><button class="mbtn" onclick="selM(this)">witchy/moody</button><button class="mbtn" onclick="selM(this)">creative</button><button class="mbtn" onclick="selM(this)">classic</button><button class="mbtn" onclick="selM(this)">bold</button></div>
    </div>
    <div class="fg" style="margin-top:0.9rem;"><label class="fl">Occasion</label>
      <select id="dmOcc"><option value="">‚Äî any ‚Äî</option><option>Stay home</option><option>Errands</option><option>School drop-off</option><option>Church</option><option>Going out</option><option>Date night</option><option>Party / event</option><option>Dressy / formal</option></select>
    </div>
    <div style="margin-top:1.1rem;"><button class="btn-p" onclick="buildOutfit()" id="dmBtn" style="width:100%;padding:0.85rem;">Build My Outfit ‚Üí</button></div>
  </div>
  <div class="spinner" id="spinner"><span class="dots">reading your closet...</span></div>
  <div class="outfit-out" id="outfitOut">
    <div class="out-name" id="outName"></div>
    <div class="out-expl" id="outExpl"></div>
    <div class="flat-lay" id="flatLay"></div>
    <div id="outPieces"></div>
    <div class="thrift-box" id="thriftBox" style="display:none;"></div>
    <div class="row-btns" style="margin-top:1.3rem;"><button class="btn-s" onclick="buildOutfit()">Try another ‚Üí</button></div>
  </div>
  <div class="empty" id="dmEmpty" style="display:none;"><div class="empty-ico">üëó</div><p class="empty-txt">Add pieces to your closet first</p></div>
</div>

<div class="section" id="looks">
  <p class="sec-title">My Looks</p>
  <p class="sec-sub">outfit journal</p>
  <div class="panel">
    <p class="ptitle-lg">Log a look</p>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">Name</label><input type="text" id="lName" placeholder="grounded romance..."></div>
        <div class="fg"><label class="fl">Date</label><input type="text" id="lDate"></div>
        <div class="fg"><label class="fl">What I wore</label><textarea id="lItems" placeholder="rust blazer + white tee + levi's..." style="min-height:60px;"></textarea></div>
      </div>
      <div>
        <div class="photo-strip">
          <div class="pslot" id="lSlot1"><input type="file" accept="image/*" onchange="slotPhoto(this,'lSlot1')"><span class="sico">üì∑</span><span class="slbl">outfit</span></div>
        </div>
      </div>
    </div>
    <div class="fg"><label class="fl">How did it feel?</label>
      <div class="react-grid">
        <button class="rbtn win" onclick="this.classList.toggle('on')">‚úì felt like me</button>
        <button class="rbtn win" onclick="this.classList.toggle('on')">‚úì effortless</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">‚úó proportion off</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">‚úó try-hard</button>
      </div>
    </div>
    <div class="fg"><label class="fl">Notes</label><textarea id="lNotes" placeholder="what worked, what I'd change..."></textarea></div>
    <button class="btn-p" onclick="logLook()">Save to Journal</button>
  </div>
  <div class="looks-grid" id="looksGrid"></div>
</div>

<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <div class="modal-hdr"><span class="modal-title" id="mName">‚Äî</span><button class="modal-x" onclick="closeModal('itemModal')">‚úï</button></div>
    <div id="mPhotoStrip" style="display:flex;gap:0.5rem;margin-bottom:1rem;"></div>
    <div id="mDetails" style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-bottom:0.5rem;"></div>
    <div class="ctags" id="mCtags" style="margin-bottom:0.6rem;"></div>
    <div style="font-size:0.78rem;color:var(--muted);font-style:italic;margin-bottom:1rem;" id="mNotes"></div>
    <div class="row-btns"><button class="btn-g" style="color:var(--rust);" onclick="deleteItem()">Remove</button></div>
  </div>
</div>

<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <div class="modal-hdr"><span class="modal-title">API Key</span><button class="modal-x" onclick="closeModal('apiModal')">‚úï</button></div>
    <p style="font-size:0.8rem;color:var(--muted);font-style:italic;line-height:1.7;margin-bottom:1rem;">Your key powers Dress Me. Stored only on your device.</p>
    <div class="fg"><label class="fl">Anthropic API Key</label><input type="password" id="apiKeyInput" placeholder="sk-ant-..."></div>
    <p style="font-family:'Courier Prime',monospace;font-size:0.52rem;color:var(--muted);margin-bottom:1rem;">Get one at console.anthropic.com</p>
    <div class="row-btns"><button class="btn-p" onclick="saveApiKey()">Save Key</button></div>
  </div>
</div>

<script>
let closet=[],looks=[],profile={},curItem=null,lastOutfit=null,selMood='',activeF='all',pendingCtags=[];
const LS={get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}},set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}}};

function autoBackup(){
  const data={version:1,exported:new Date().toISOString(),closet,looks,profile};
  const json=JSON.stringify(data);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`worn-autosave-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  updateBackupStatus(true);
}

function updateBackupStatus(fresh){
  const el=document.getElementById('backupStatus');
  if(fresh){el.textContent='‚úì data protected';el.className='backup-status fresh';}
  else{el.textContent='‚úì data loaded';el.className='backup-status';}
}

function manualExport(){autoBackup();}

function importData(input){
  if(!input.files[0])return;
  const r=new FileReader();
  r.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.version)return alert('Invalid backup file');
      if(!confirm(`Import backup from ${data.exported?.slice(0,10)||'unknown'}?`))return;
      if(data.closet)closet=data.closet;if(data.looks)looks=data.looks;if(data.profile)profile=data.profile;
      LS.set('w_closet',closet);LS.set('w_looks',looks);LS.set('w_profile',profile);
      loadProfile();renderCloset();renderLooks();updateWeather();
      alert('‚úì Data restored');
    }catch{alert('Could not read backup file');}
  };
  r.readAsText(input.files[0]);input.value='';
}

window.addEventListener('load',()=>{
  closet=LS.get('w_closet',[]);looks=LS.get('w_looks',[]);profile=LS.get('w_profile',{});
  loadProfile();renderCloset();renderLooks();updateWeather();checkApiKey();updateBackupStatus(false);
  document.getElementById('lDate').value=new Date().toLocaleDateString();
});

function nav(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');btn.classList.add('active');
  if(id==='dressme')checkDM();
}

function sel(btn,grp){document.querySelectorAll(`#${grp} .tp`).forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function tog(btn){btn.classList.toggle('on');}
function getOne(grp){const s=document.querySelector(`#${grp} .tp.on`);return s?s.textContent:'';}
function getMany(grp){return[...document.querySelectorAll(`#${grp} .tp.on`)].map(b=>b.textContent);}

function addCtag(){
  const inp=document.getElementById('ctagIn');const v=inp.value.trim().replace(/^#/,'');
  if(!v||pendingCtags.includes(v)){inp.value='';return;}
  pendingCtags.push(v);renderCtags();inp.value='';
}
function renderCtags(){document.getElementById('ctagDisplay').innerHTML=pendingCtags.map((t,i)=>`<span class="ctag">#${t}<span class="ctx" onclick="rmCtag(${i})">√ó</span></span>`).join('');}
function rmCtag(i){pendingCtags.splice(i,1);renderCtags();}

const CTAGS={
  clothing:{Structure:['Soft','Balanced','Structured'],'Visual Weight':['Light','Medium','Heavy'],Energy:['Romantic','Grounded','Edgy','Playful','Neutral'],'Role':['Core','Anchor','Support','Accent']},
  footwear:{Structure:['Soft','Structured'],Energy:['Grounded','Edgy','Romantic','Neutral'],'Role':['Anchor','Support','Statement']},
  jewelry:{Metal:['Gold','Silver','Oxidized silver','Mixed','Brass','None'],Style:['Delicate','Chunky','Vintage','Witchy','Minimal','Statement','Layering'],Weight:['Delicate','Medium','Statement'],Energy:['Romantic','Edgy','Grounded','Mystical']},
  accessories:{Structure:['Soft','Structured'],'Visual Weight':['Light','Medium','Heavy'],Energy:['Romantic','Grounded','Edgy','Neutral'],'Role':['Anchor','Support','Accent','Statement']}
};
const CGRPS={clothing:['Top','Bottom','Dress','Outerwear','Modesty Layer'],footwear:['Shoes','Boots','Sandals','Sneakers'],jewelry:['Necklace','Earrings','Ring','Bracelet','Anklet','Body Jewelry','Hair Jewelry'],accessories:['Belt','Bag','Hat','Scarf','Socks / Tights','Sunglasses','Other']};
const CPHOTOS={clothing:[{l:'piece alone',i:'üì∏'},{l:'on base',i:'ü™û'},{l:'in wild',i:'‚ú®'}],footwear:[{l:'piece alone',i:'üì∏'},{l:'on you',i:'ü¶∂'},{l:'in outfit',i:'‚ú®'}],jewelry:[{l:'piece alone',i:'üì∏'},{l:'worn',i:'üíé'},{l:'in look',i:'‚ú®'}],accessories:[{l:'piece alone',i:'üì∏'},{l:'styled',i:'ü™û'},{l:'in outfit',i:'‚ú®'}]};
function getCG(cat){for(const[g,cs]of Object.entries(CGRPS)){if(cs.includes(cat))return g;}return 'clothing';}

function updateDynTags(){
  const cat=document.getElementById('iCat').value;const g=getCG(cat);const td=CTAGS[g]||CTAGS.clothing;const ph=CPHOTOS[g]||CPHOTOS.clothing;
  document.getElementById('dynTags').innerHTML=Object.entries(td).map(([lbl,opts])=>`<div class="fg"><label class="fl">${lbl}</label><div class="tag-group" id="dyn_${lbl.replace(/\s/g,'_')}">${opts.map(o=>`<button class="tp" onclick="sel(this,'dyn_${lbl.replace(/\s/g,'_')}')">${o}</button>`).join('')}</div></div>`).join('');
  const strip=document.getElementById('photoStrip');const hint=document.getElementById('photoHint');
  if(!cat){strip.innerHTML='';hint.style.display='block';return;}hint.style.display='none';
  strip.innerHTML=ph.map((p,idx)=>`<div class="pslot" id="aSlot${idx}"><input type="file" accept="image/*" onchange="slotPhoto(this,'aSlot${idx}')"><span class="sico">${p.i}</span><span class="slbl">${p.l}</span></div>`).join('');
}

function slotPhoto(input,slotId){
  if(!input.files[0])return;
  const r=new FileReader();r.onload=e=>{
    const s=document.getElementById(slotId);if(!s)return;let img=s.querySelector('img');
    if(!img){img=document.createElement('img');s.appendChild(img);}
    img.src=e.target.result;s.classList.add('hi');s.dataset.img=e.target.result;
  };r.readAsDataURL(input.files[0]);
}

function addItem(){
  const name=document.getElementById('iName').value.trim();const cat=document.getElementById('iCat').value;
  if(!name){alert('Give the piece a name.');return;}if(!cat){alert('Select a category.');return;}
  const g=getCG(cat);const td=CTAGS[g]||CTAGS.clothing;const dynTags={};
  Object.keys(td).forEach(lbl=>{dynTags[lbl]=getOne('dyn_'+lbl.replace(/\s/g,'_'));});
  const photos=[0,1,2].map(i=>{const s=document.getElementById(`aSlot${i}`);return s?.dataset?.img||'';});
  const item={id:Date.now(),name,cat,grp:g,color:document.getElementById('iColor').value,source:document.getElementById('iSource').value,dynTags,occasions:getMany('tOcc'),customTags:[...pendingCtags],notes:document.getElementById('iNotes').value,photos,wearCount:0,dateAdded:new Date().toLocaleDateString()};
  closet.push(item);LS.set('w_closet',closet);renderCloset();clearForm();autoBackup();
}

function clearForm(){
  ['iName','iColor','iSource','iNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('iCat').value='';document.querySelectorAll('#tOcc .tp').forEach(t=>t.classList.remove('on'));
  pendingCtags=[];renderCtags();document.getElementById('photoStrip').innerHTML='';
  document.getElementById('photoHint').style.display='block';document.getElementById('dynTags').innerHTML='';document.getElementById('ctagIn').value='';
}

function setF(f,btn){activeF=f;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');renderCloset();}

function filtered(){
  const q=(document.getElementById('searchIn')?.value||'').toLowerCase();
  return closet.filter(item=>{
    const gm=activeF==='all'||item.grp===activeF;if(!gm)return false;if(!q)return true;
    return[item.name,item.color,item.cat,item.source,...(item.occasions||[]),...(item.customTags||[]),item.notes,...Object.values(item.dynTags||{})].join(' ').toLowerCase().includes(q);
  });
}

const ICONS={Top:'üëï',Bottom:'üëñ',Dress:'üëó',Outerwear:'üß•','Modesty Layer':'ü´∂',Shoes:'üëü',Boots:'ü•æ',Sandals:'üë°',Sneakers:'üëü',Necklace:'üìø',Earrings:'üíé',Ring:'üíç',Bracelet:'‚ú®',Anklet:'‚ú®','Body Jewelry':'üí´','Hair Jewelry':'üå∏',Belt:'ü™¢',Bag:'üëú',Hat:'üé©',Scarf:'üß£','Socks / Tights':'üß¶',Sunglasses:'üï∂Ô∏è',Other:'ü™°'};
function ico(cat){return ICONS[cat]||'ü™°';}

function renderCloset(){
  const grid=document.getElementById('closetGrid');const items=filtered();
  if(!items.length){grid.innerHTML=`<div class="empty"><div class="empty-ico">üß•</div><p class="empty-txt">${closet.length?'No matches':'Your closet is empty'}</p></div>`;return;}
  grid.innerHTML=items.map(item=>`<div class="ccard" onclick="openItem(${item.id})">${item.photos?.[0]?`<img class="ccard-img" src="${item.photos[0]}" loading="lazy">`:`<div class="ccard-ph">${ico(item.cat)}</div>`}<div class="ccard-info"><div class="ccard-name">${item.name}</div><div class="ccard-tags">${item.dynTags?.['Role']?`<span class="mt ${item.dynTags['Role']==='Anchor'?'anc':item.dynTags['Role']==='Core'?'cor':''}">${item.dynTags['Role']}</span>`:''} ${item.dynTags?.['Energy']?`<span class="mt">${item.dynTags['Energy']}</span>`:''} ${(item.customTags||[]).slice(0,2).map(t=>`<span class="mt cus">#${t}</span>`).join('')}</div></div></div>`).join('');
}

function openItem(id){
  curItem=closet.find(i=>i.id===id);if(!curItem)return;
  document.getElementById('mName').textContent=curItem.name;
  const ph=CPHOTOS[curItem.grp]||CPHOTOS.clothing;
  document.getElementById('mPhotoStrip').innerHTML=ph.map((p,i)=>`<div class="pslot" style="flex:1;" id="ms${i}"><input type="file" accept="image/*" onchange="updPhoto(this,${i})">${curItem.photos?.[i]?`<img src="${curItem.photos[i]}">`:''}  <span class="sico">${p.i}</span><span class="slbl">${p.l}</span></div>`).join('');
  curItem.photos?.forEach((p,i)=>{if(p)document.getElementById(`ms${i}`)?.classList.add('hi');});
  document.getElementById('mDetails').innerHTML=[`<span class="mt">${curItem.cat}</span>`,curItem.color?`<span class="mt">${curItem.color}</span>`:'', ...Object.entries(curItem.dynTags||{}).filter(([,v])=>v).map(([,v])=>`<span class="mt">${v}</span>`),...(curItem.occasions||[]).map(o=>`<span class="mt occ">${o}</span>`)].join('');
  document.getElementById('mCtags').innerHTML=(curItem.customTags||[]).map(t=>`<span class="ctag">#${t}</span>`).join('');
  document.getElementById('mNotes').textContent=curItem.notes||'';
  document.getElementById('itemModal').classList.add('open');
}

function updPhoto(input,idx){
  if(!curItem||!input.files[0])return;
  const r=new FileReader();r.onload=e=>{if(!curItem.photos)curItem.photos=[];curItem.photos[idx]=e.target.result;LS.set('w_closet',closet);openItem(curItem.id);renderCloset();autoBackup();};r.readAsDataURL(input.files[0]);
}

function deleteItem(){
  if(!curItem||!confirm(`Remove "${curItem.name}"?`))return;
  closet=closet.filter(i=>i.id!==curItem.id);LS.set('w_closet',closet);renderCloset();closeModal('itemModal');autoBackup();
}

function closeModal(id){document.getElementById(id).classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))closeModal(e.target.id);});

function saveProfile(){
  profile={photo:profile.photo||'',poles:{ss:document.getElementById('pSS').value,rs:document.getElementById('pRS').value,vm:document.getElementById('pVM').value},body:{love:document.getElementById('bLove').value,down:document.getElementById('bDown').value,notes:document.getElementById('bNotes').value,height:document.getElementById('mH').value,bust:document.getElementById('mB').value,waist:document.getElementById('mWa').value,hips:document.getElementById('mHi').value},location:document.getElementById('uLoc').value,season:document.getElementById('uSea').value};
  LS.set('w_profile',profile);
  const btn=document.querySelector('#profile .btn-p');btn.textContent='Saved ‚úì';setTimeout(()=>btn.textContent='Save Profile',2000);
  updateWeather();autoBackup();
}

function setProfilePhoto(input){
  if(!input.files[0])return;
  const r=new FileReader();r.onload=e=>{
    profile.photo=e.target.result;LS.set('w_profile',profile);
    const s=document.getElementById('profPhotoSlot');let img=s.querySelector('img');
    if(!img){img=document.createElement('img');s.appendChild(img);}img.src=e.target.result;autoBackup();
  };r.readAsDataURL(input.files[0]);
}

function loadProfile(){
  if(!profile||!Object.keys(profile).length)return;
  if(profile.poles){['ss','rs','vm'].forEach(k=>{const el=document.getElementById('p'+k.toUpperCase());if(el&&profile.poles[k])el.value=profile.poles[k];});}
  if(profile.body){const b=profile.body;[['bLove','love'],['bDown','down'],['bNotes','notes'],['mH','height'],['mB','bust'],['mWa','waist'],['mHi','hips']].forEach(([id,key])=>{const el=document.getElementById(id);if(el&&b[key])el.value=b[key];});}
  if(profile.location)document.getElementById('uLoc').value=profile.location;
  if(profile.season)document.getElementById('uSea').value=profile.season;
  if(profile.photo){const s=document.getElementById('profPhotoSlot');let img=s.querySelector('img');if(!img){img=document.createElement('img');s.appendChild(img);}img.src=profile.photo;}
}

function showApiModal(){
  const existing=LS.get('w_apikey','');if(existing)document.getElementById('apiKeyInput').value=existing;
  document.getElementById('apiModal').classList.add('open');
}

function saveApiKey(){
  const key=document.getElementById('apiKeyInput').value.trim();if(!key){alert('Enter key');return;}
  LS.set('w_apikey',key);closeModal('apiModal');checkApiKey();alert('‚úì Key saved');
}

function checkApiKey(){
  const key=LS.get('w_apikey','');const banner=document.getElementById('apiBanner');
  if(banner)banner.className=key?'api-banner hidden':'api-banner';
}

function getApiKey(){return LS.get('w_apikey','');}

function selM(btn){document.querySelectorAll('.mbtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');selMood=btn.textContent;}
function checkDM(){const e=document.getElementById('dmEmpty');const b=document.getElementById('dmBtn');if(closet.length<3){e.style.display='block';b.disabled=true;}else{e.style.display='none';b.disabled=false;}}

async function buildOutfit(){
  if(closet.length<3)return;
  const apiKey=getApiKey();if(!apiKey){showApiModal();return;}
  document.getElementById('outfitOut').classList.remove('show');
  document.getElementById('spinner').classList.add('show');
  document.getElementById('dmBtn').disabled=true;

  const byGrp={};closet.forEach(item=>{if(!byGrp[item.grp])byGrp[item.grp]=[];byGrp[item.grp].push(item);});
  const closetStr=Object.entries(byGrp).map(([g,items])=>`[${g.toUpperCase()}]\n${items.map(i=>{const tags=Object.entries(i.dynTags||{}).filter(([,v])=>v).map(([k,v])=>`${k}:${v}`).join('|');const ct=(i.customTags||[]).map(t=>`#${t}`).join(' ');return`  ‚Ä¢ ${i.name} (${i.cat}) | ${i.color||'?'} | ${tags} | ${ct}`;}).join('\n')}`).join('\n\n');

  const prof=`Poles: soft‚Üístructured:${profile.poles?.ss||50} | romantic‚Üísevere:${profile.poles?.rs||30} | vintage‚Üímodern:${profile.poles?.vm||25}
Body: loves:${profile.body?.love||'?'} downplay:${profile.body?.down||'?'}
Measurements: height:${profile.body?.height||'?'} bust:${profile.body?.bust||'?'} waist:${profile.body?.waist||'?'} hips:${profile.body?.hips||'?'}
Location: ${profile.location||'Utah'} | Season: ${profile.season||'Winter'}`;

  const hist=looks.length?looks.slice(0,5).map(l=>`"${l.name}": ${l.items}`).join('\n'):'No history';

  const prompt=`You are Worn ‚Äî Heather's AI stylist.

STYLE DNA:
Vintage-driven, thrifted, romantic but grounded. Soft + structured, feminine + edgy. Tension = success. Slightly witchy, vintage, rugged. Quiet effortless heat.

RULES:
1. Romantic Core + Grounding Anchor always
2. Never all-soft or all-structured
3. Build head-to-toe: Core + Anchor + Footwear minimum
4. Reference her measurements when explaining fit

PROFILE:
${prof}

CLOSET:
${closetStr||'Empty'}

HISTORY:
${hist}

REQUEST:
Vibe: ${selMood||'not stated'}
Occasion: ${document.getElementById('dmOcc').value||'everyday'}

Build a complete head-to-toe outfit using actual pieces from her closet.

FORMAT:
OUTFIT_NAME: [2-4 words]
EXPLANATION: [2-3 sentences to Heather about why this works on her body]
PIECES:
CORE: [exact name]
ANCHOR: [exact name]
FOOTWEAR: [exact name]
BELT: [exact name or none]
JEWELRY: [up to 3, or none]`;

  try{
    const res=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})
    });
    
    if(!res.ok){
      const errText=await res.text();
      throw new Error(`HTTP ${res.status}: ${errText.slice(0,200)}`);
    }
    
    const data=await res.json();
    if(data.error){throw new Error(data.error.message);}
    const text=data.content?.[0]?.text||'';
    document.getElementById('spinner').classList.remove('show');
    document.getElementById('dmBtn').disabled=false;
    parseOutfit(text);
  }catch(e){
    document.getElementById('spinner').classList.remove('show');
    document.getElementById('dmBtn').disabled=false;
    document.getElementById('outName').textContent='Error';
    document.getElementById('outExpl').textContent=`API error: ${e.message}`;
    document.getElementById('flatLay').innerHTML='';
    document.getElementById('outPieces').innerHTML='';
    document.getElementById('thriftBox').style.display='none';
    document.getElementById('outfitOut').classList.add('show');
  }
}

function parseOutfit(text){
  const get=lbl=>{const m=text.match(new RegExp(`${lbl}:\\s*(.+)`,'i'));return m?m[1].trim():'';};
  const name=get('OUTFIT_NAME');const expl=text.match(/EXPLANATION:\s*([\s\S]*?)(?=PIECES:|$)/i)?.[1]?.trim()||'';
  const pieces=[];
  [['CORE','Core'],['ANCHOR','Anchor'],['FOOTWEAR','Footwear'],['BELT','Belt'],['JEWELRY','Jewelry']].forEach(([key,role])=>{
    const v=get(key);if(!v||v.toLowerCase()==='none')return;
    if(key==='JEWELRY'){v.split(/[,;]/).map(x=>x.trim()).filter(x=>x&&x.toLowerCase()!=='none').forEach(x=>pieces.push({role,name:x}));}
    else pieces.push({role,name:v});
  });
  lastOutfit={name,expl,pieces};
  document.getElementById('outName').textContent=name||'Your Outfit';
  document.getElementById('outExpl').textContent=expl;
  document.getElementById('flatLay').innerHTML=pieces.map(p=>{const item=closet.find(c=>c.name.toLowerCase()===p.name.toLowerCase())||closet.find(c=>c.name.toLowerCase().includes(p.name.toLowerCase().split(' ')[0]));const ph=item?.photos?.find(x=>x);return ph?`<div class="fl-piece"><img src="${ph}"><span>${p.role}</span></div>`:`<div class="fl-piece"><span class="fl-piece-ico">${ico(item?.cat||'')}</span><span>${p.name.split(' ').slice(0,2).join(' ')}</span><span>${p.role}</span></div>`;}).join('');
  document.getElementById('outPieces').innerHTML=pieces.map(p=>`<div class="piece-row"><span class="p-role">${p.role}</span><span class="p-name">${p.name}</span></div>`).join('');
  document.getElementById('outfitOut').classList.add('show');
}

function logLook(){
  const name=document.getElementById('lName').value.trim();if(!name){alert('Name your look');return;}
  const photo1=document.getElementById('lSlot1').dataset.img||'';
  const look={id:Date.now(),name,date:document.getElementById('lDate').value||new Date().toLocaleDateString(),items:document.getElementById('lItems').value,photos:[photo1].filter(Boolean),wins:[...document.querySelectorAll('.rbtn.win.on')].map(b=>b.textContent.replace('‚úì ','')),misses:[...document.querySelectorAll('.rbtn.miss.on')].map(b=>b.textContent.replace('‚úó ','')),notes:document.getElementById('lNotes').value};
  looks.unshift(look);LS.set('w_looks',looks);renderLooks();clearLook();autoBackup();
}

function clearLook(){
  ['lName','lItems','lNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('lDate').value=new Date().toLocaleDateString();
  ['lSlot1'].forEach(id=>{const s=document.getElementById(id);s.classList.remove('hi');delete s.dataset.img;const img=s.querySelector('img');if(img)img.remove();});
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('on'));
}

function renderLooks(){
  const grid=document.getElementById('looksGrid');
  if(!looks.length){grid.innerHTML=`<div class="empty"><div class="empty-ico">üìñ</div><p class="empty-txt">Journal is empty</p></div>`;return;}
  grid.innerHTML=looks.map(l=>`<div class="lcard">${l.photos?.[0]?`<img class="lcard-img" src="${l.photos[0]}">`:`<div class="lcard-ph">ü™û</div>`}<div class="lcard-info"><div class="lcard-name">${l.name}</div><div class="lcard-date">${l.date}</div><div style="display:flex;flex-wrap:wrap;gap:0.2rem;">${(l.wins||[]).map(t=>`<span class="rtag win">${t}</span>`).join('')}${(l.misses||[]).map(t=>`<span class="rtag miss">${t}</span>`).join('')}</div>${l.notes?`<div class="lcard-notes">"${l.notes}"</div>`:''}</div></div>`).join('');
}

function updateWeather(){
  const loc=profile.location||'Utah';const sea=profile.season||'Winter';
  const c={Winter:['cold & crisp','snowy','bitter'],Spring:['mild & breezy','cool mornings'],Summer:['warm & dry','hot'],Fall:['crisp & golden','windy']};
  const t=(c[sea]||c.Winter)[new Date().getDay()%3];
  document.getElementById('weatherDisplay').innerHTML=`${loc.split(',')[0]}<br>${sea.toLowerCase()} ‚Äî ${t}`;
}
</script>
</body>
</html>

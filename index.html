<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#2c1f14">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WORN">
<title>WORN</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400&family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
:root{--ink:#1a1410;--parchment:#f0ead8;--warm-dark:#2c1f14;--rust:#8b3a2a;--dusty-rose:#c4907a;--aged-gold:#b8963e;--sage:#7a8c6e;--cream:#ede5d0;--muted:#6b5a4a;--jewel:#5c4a7a;--jewel-light:#9b84c4;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--warm-dark);color:var(--parchment);font-family:'Libre Baskerville',serif;min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.07'/%3E%3C/svg%3E");opacity:0.4;pointer-events:none;z-index:1000;}
.header{text-align:center;padding:2.5rem 1rem 1rem;position:relative;border-bottom:1px solid rgba(184,150,62,0.3);}
.header h1{font-family:'Cormorant Garamond',serif;font-size:clamp(3rem,8vw,5.5rem);font-weight:300;letter-spacing:0.5em;text-transform:uppercase;line-height:1;}
.tagline{font-family:'Courier Prime',monospace;font-size:0.65rem;letter-spacing:0.3em;color:var(--aged-gold);text-transform:uppercase;margin-top:0.5rem;opacity:0.8;}
.weather-pill{position:absolute;top:1.5rem;right:1.2rem;font-family:'Courier Prime',monospace;font-size:0.62rem;letter-spacing:0.12em;color:var(--dusty-rose);text-align:right;line-height:1.6;}
.nav{display:flex;border-bottom:1px solid rgba(184,150,62,0.3);overflow-x:auto;scrollbar-width:none;}
.nav::-webkit-scrollbar{display:none;}
.nav-btn{font-family:'Courier Prime',monospace;font-size:0.56rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);background:none;border:none;border-bottom:2px solid transparent;padding:0.9rem 1.1rem;cursor:pointer;transition:all 0.3s;white-space:nowrap;flex-shrink:0;}
.nav-btn:hover{color:var(--parchment);}
.nav-btn.active{color:var(--aged-gold);border-bottom-color:var(--aged-gold);}
.section{display:none;padding:1.5rem 1rem 3rem;max-width:960px;margin:0 auto;}
.section.active{display:block;animation:fadeIn 0.35s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}
.sec-title{font-family:'Cormorant Garamond',serif;font-size:1.8rem;font-weight:300;font-style:italic;margin-bottom:0.2rem;}
.sec-sub{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.2em;color:var(--muted);text-transform:uppercase;margin-bottom:1.4rem;}
.btn-p{font-family:'Courier Prime',monospace;font-size:0.62rem;letter-spacing:0.2em;text-transform:uppercase;background:var(--rust);color:var(--parchment);border:none;padding:0.7rem 1.4rem;cursor:pointer;transition:all 0.2s;}
.btn-p:hover{background:var(--dusty-rose);color:var(--ink);}
.btn-p:disabled{opacity:0.4;cursor:not-allowed;}
.btn-s{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.18em;text-transform:uppercase;background:transparent;color:var(--aged-gold);border:1px solid rgba(184,150,62,0.4);padding:0.5rem 1rem;cursor:pointer;transition:all 0.2s;}
.btn-s:hover{background:rgba(184,150,62,0.1);}
.btn-g{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.15em;text-transform:uppercase;background:transparent;color:var(--muted);border:1px solid rgba(107,90,74,0.4);padding:0.4rem 0.8rem;cursor:pointer;transition:all 0.2s;}
.btn-g:hover{color:var(--parchment);border-color:var(--muted);}
.fg{margin-bottom:1.1rem;}
.fl{display:block;font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.2em;text-transform:uppercase;color:var(--aged-gold);margin-bottom:0.35rem;}
input[type=text],input[type=number],input[type=password],textarea,select{width:100%;background:rgba(26,20,16,0.6);border:1px solid rgba(107,90,74,0.4);color:var(--parchment);font-family:'Libre Baskerville',serif;font-size:0.84rem;padding:0.55rem 0.75rem;outline:none;transition:border-color 0.2s;-webkit-appearance:none;border-radius:0;}
input:focus,textarea:focus,select:focus{border-color:var(--aged-gold);}
textarea{min-height:70px;resize:vertical;}
select option{background:var(--warm-dark);}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.8rem;}
@media(max-width:520px){.g2,.g3{grid-template-columns:1fr;}}
.tag-group{display:flex;flex-wrap:wrap;gap:0.35rem;margin-top:0.35rem;}
.tp{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.28rem 0.65rem;border:1px solid rgba(107,90,74,0.5);color:var(--muted);cursor:pointer;transition:all 0.2s;background:transparent;}
.tp:hover{color:var(--parchment);border-color:var(--muted);}
.tp.on{background:var(--rust);color:var(--parchment);border-color:var(--rust);}
.ctag-wrap{display:flex;gap:0.4rem;margin-top:0.5rem;align-items:center;}
.ctag-wrap input{flex:1;font-size:0.78rem;}
.ctags{display:flex;flex-wrap:wrap;gap:0.3rem;margin-top:0.4rem;}
.ctag{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.1em;padding:0.25rem 0.55rem;background:rgba(92,74,122,0.25);color:var(--jewel-light);border:1px solid rgba(92,74,122,0.4);display:inline-flex;align-items:center;gap:0.3rem;}
.ctx{cursor:pointer;opacity:0.6;font-size:0.75rem;}
.ctx:hover{opacity:1;}
.photo-strip{display:flex;gap:0.5rem;margin-bottom:0.5rem;}
.pslot{flex:1;min-width:0;aspect-ratio:2/3;background:rgba(26,20,16,0.6);border:1px dashed rgba(107,90,74,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;transition:border-color 0.2s;}
.pslot:hover{border-color:var(--aged-gold);}
.pslot input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;padding:0;border:none;background:transparent;}
.pslot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.pslot .slbl{font-family:'Courier Prime',monospace;font-size:0.46rem;letter-spacing:0.09em;text-transform:uppercase;color:var(--muted);text-align:center;padding:0.3rem;line-height:1.5;pointer-events:none;z-index:1;position:relative;}
.pslot .sico{font-size:1.1rem;margin-bottom:0.15rem;pointer-events:none;z-index:1;position:relative;}
.pslot.hi .slbl,.pslot.hi .sico{opacity:0;}
.panel{background:rgba(26,20,16,0.5);border:1px solid rgba(107,90,74,0.3);padding:1.4rem;margin-bottom:1.3rem;}
.ptitle{font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.25em;text-transform:uppercase;color:var(--aged-gold);margin-bottom:1rem;padding-bottom:0.45rem;border-bottom:1px solid rgba(184,150,62,0.2);}
.ptitle-lg{font-family:'Cormorant Garamond',serif;font-size:1.25rem;font-weight:300;font-style:italic;color:var(--parchment);margin-bottom:0.9rem;}
.filter-bar{display:flex;flex-wrap:wrap;gap:0.35rem;margin-bottom:1rem;}
.fbtn{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;padding:0.3rem 0.7rem;border:1px solid rgba(107,90,74,0.4);color:var(--muted);background:transparent;cursor:pointer;transition:all 0.2s;}
.fbtn:hover,.fbtn.on{background:rgba(184,150,62,0.15);color:var(--aged-gold);border-color:var(--aged-gold);}
.search-bar{display:flex;gap:0.5rem;margin-bottom:0.8rem;}
.search-bar input{flex:1;}
.closet-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(125px,1fr));gap:0.9rem;margin-top:1rem;}
.ccard{background:rgba(26,20,16,0.7);border:1px solid rgba(107,90,74,0.3);cursor:pointer;transition:all 0.2s;overflow:hidden;}
.ccard:hover{border-color:var(--aged-gold);transform:translateY(-2px);}
.ccard-img{width:100%;aspect-ratio:3/4;object-fit:cover;display:block;background:rgba(44,31,20,0.8);}
.ccard-ph{width:100%;aspect-ratio:3/4;display:flex;align-items:center;justify-content:center;background:rgba(44,31,20,0.6);color:var(--muted);font-size:1.8rem;}
.ccard-info{padding:0.45rem 0.5rem;}
.ccard-name{font-family:'Cormorant Garamond',serif;font-size:0.82rem;color:var(--parchment);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:0.2rem;}
.ccard-tags{display:flex;flex-wrap:wrap;gap:0.15rem;}
.mt{font-family:'Courier Prime',monospace;font-size:0.42rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.12rem 0.3rem;background:rgba(107,90,74,0.3);color:var(--muted);}
.mt.anc{background:rgba(139,58,42,0.35);color:var(--dusty-rose);}
.mt.cor{background:rgba(122,140,110,0.25);color:var(--sage);}
.mt.cus{background:rgba(92,74,122,0.25);color:var(--jewel-light);}
.mt.occ{background:rgba(184,150,62,0.15);color:var(--aged-gold);}
.pole-row{display:flex;align-items:center;gap:0.8rem;margin-bottom:0.7rem;}
.plbl{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.09em;text-transform:uppercase;width:72px;text-align:right;color:var(--parchment);flex-shrink:0;}
.plbl.r{text-align:left;}
.pole-slider{flex:1;-webkit-appearance:none;height:2px;background:linear-gradient(to right,var(--dusty-rose),var(--ink),var(--sage));outline:none;border:none;padding:0;cursor:pointer;}
.pole-slider::-webkit-slider-thumb{-webkit-appearance:none;width:13px;height:13px;background:var(--aged-gold);border-radius:50%;cursor:pointer;border:2px solid var(--warm-dark);}
.quiz-q{margin-bottom:1.2rem;}
.quiz-qt{font-family:'Cormorant Garamond',serif;font-size:0.98rem;font-style:italic;color:var(--cream);margin-bottom:0.5rem;}
.qopts{display:flex;flex-wrap:wrap;gap:0.4rem;}
.qo{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.1em;text-transform:uppercase;padding:0.35rem 0.75rem;border:1px solid rgba(107,90,74,0.4);color:var(--muted);cursor:pointer;transition:all 0.2s;background:transparent;}
.qo:hover{color:var(--parchment);border-color:var(--muted);}
.qo.on{background:rgba(139,58,42,0.3);color:var(--dusty-rose);border-color:var(--rust);}
.meas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:0.7rem;}
.mf{display:flex;flex-direction:column;gap:0.3rem;}
.mf label{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--aged-gold);}
.prof-photo-slot{width:110px;flex-shrink:0;aspect-ratio:2/3;background:rgba(26,20,16,0.6);border:1px dashed rgba(107,90,74,0.4);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;overflow:hidden;cursor:pointer;transition:border-color 0.2s;}
.prof-photo-slot:hover{border-color:var(--aged-gold);}
.prof-photo-slot input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;border:none;background:transparent;}
.prof-photo-slot img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;}
.mood-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.4rem;margin-top:0.4rem;}
.mbtn{font-family:'Cormorant Garamond',serif;font-size:0.88rem;font-style:italic;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.55rem 0.3rem;cursor:pointer;transition:all 0.2s;text-align:center;}
.mbtn:hover,.mbtn.on{background:rgba(139,58,42,0.25);color:var(--parchment);border-color:var(--dusty-rose);}
.intent-row{display:flex;gap:0.4rem;margin-top:0.4rem;}
.ibtn{flex:1;font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.12em;text-transform:uppercase;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.55rem 0.3rem;cursor:pointer;transition:all 0.2s;text-align:center;}
.ibtn:hover,.ibtn.on{border-color:var(--aged-gold);color:var(--aged-gold);background:rgba(184,150,62,0.08);}
.outfit-out{background:rgba(26,20,16,0.7);border:1px solid rgba(184,150,62,0.3);padding:1.4rem;display:none;animation:fadeIn 0.5s ease;}
.outfit-out.show{display:block;}
.out-name{font-family:'Cormorant Garamond',serif;font-size:1.6rem;font-weight:300;font-style:italic;color:var(--aged-gold);margin-bottom:0.3rem;}
.out-expl{font-family:'Libre Baskerville',serif;font-size:0.8rem;line-height:1.75;color:var(--cream);margin:0.9rem 0;font-style:italic;}
.flat-lay{display:flex;flex-wrap:wrap;gap:0.6rem;padding:1rem;background:rgba(44,31,20,0.35);margin:0.8rem 0;justify-content:center;min-height:70px;align-items:center;}
.fl-piece{text-align:center;}
.fl-piece img{width:60px;height:78px;object-fit:cover;border:1px solid rgba(107,90,74,0.35);}
.fl-piece span{display:block;font-family:'Courier Prime',monospace;font-size:0.42rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--rust);margin-top:0.2rem;}
.fl-piece-ico{font-size:1.8rem;display:block;}
.piece-row{display:flex;align-items:center;gap:0.7rem;padding:0.5rem 0;border-bottom:1px solid rgba(107,90,74,0.18);}
.p-role{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.12em;text-transform:uppercase;color:var(--rust);width:80px;flex-shrink:0;}
.p-name{font-family:'Cormorant Garamond',serif;font-size:0.98rem;color:var(--parchment);}
.thrift-box{background:rgba(122,140,110,0.12);border:1px solid rgba(122,140,110,0.28);border-left:3px solid var(--sage);padding:0.75rem 1rem;margin-top:0.9rem;font-family:'Libre Baskerville',serif;font-size:0.78rem;font-style:italic;color:var(--cream);line-height:1.6;}
.thrift-box::before{content:'â€” thrift radar';display:block;font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--sage);margin-bottom:0.35rem;font-style:normal;}
.spinner{text-align:center;padding:2rem;font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--muted);display:none;}
.spinner.show{display:block;}
@keyframes pulse{0%,100%{opacity:0.3;}50%{opacity:1;}}
.dots{animation:pulse 1.4s ease-in-out infinite;}
.looks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(185px,1fr));gap:1rem;margin-top:1rem;}
.lcard{background:rgba(26,20,16,0.7);border:1px solid rgba(107,90,74,0.3);overflow:hidden;}
.lcard-img{width:100%;aspect-ratio:2/3;object-fit:cover;}
.lcard-ph{width:100%;aspect-ratio:2/3;display:flex;align-items:center;justify-content:center;background:rgba(44,31,20,0.6);color:var(--muted);font-size:2.5rem;}
.lcard-info{padding:0.75rem;}
.lcard-name{font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--aged-gold);margin-bottom:0.2rem;}
.lcard-date{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.1em;color:var(--muted);margin-bottom:0.4rem;}
.rtag{font-family:'Courier Prime',monospace;font-size:0.46rem;letter-spacing:0.08em;text-transform:uppercase;padding:0.18rem 0.38rem;}
.rtag.win{background:rgba(122,140,110,0.28);color:var(--sage);}
.rtag.miss{background:rgba(139,58,42,0.28);color:var(--dusty-rose);}
.rtag.neu{background:rgba(107,90,74,0.28);color:var(--muted);}
.lcard-notes{font-family:'Libre Baskerville',serif;font-size:0.7rem;color:var(--muted);font-style:italic;line-height:1.5;margin-top:0.4rem;}
.react-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.35rem;margin-top:0.4rem;}
.rbtn{font-family:'Courier Prime',monospace;font-size:0.5rem;letter-spacing:0.09em;text-transform:uppercase;background:transparent;border:1px solid rgba(107,90,74,0.4);color:var(--muted);padding:0.42rem;cursor:pointer;transition:all 0.2s;text-align:center;}
.rbtn.win.on{background:rgba(122,140,110,0.28);color:var(--sage);border-color:var(--sage);}
.rbtn.miss.on{background:rgba(139,58,42,0.28);color:var(--dusty-rose);border-color:var(--dusty-rose);}
.rbtn.neu.on{background:rgba(107,90,74,0.28);color:var(--parchment);border-color:var(--muted);}
.traj-box{background:rgba(122,140,110,0.08);border:1px solid rgba(122,140,110,0.2);border-left:3px solid var(--sage);padding:0.75rem 1rem;margin-top:1rem;}
.traj-lbl{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.18em;text-transform:uppercase;color:var(--sage);margin-bottom:0.25rem;}
.traj-txt{font-family:'Cormorant Garamond',serif;font-size:0.9rem;font-style:italic;color:var(--cream);line-height:1.5;}
.empty{text-align:center;padding:2.5rem 1rem;grid-column:1/-1;}
.empty-ico{font-size:2.5rem;margin-bottom:0.8rem;opacity:0.35;}
.empty-txt{font-family:'Cormorant Garamond',serif;font-size:1rem;font-style:italic;color:var(--muted);}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(26,20,16,0.96);z-index:500;overflow-y:auto;padding:1.5rem 1rem;}
.modal-overlay.open{display:flex;align-items:flex-start;justify-content:center;}
.modal{background:var(--warm-dark);border:1px solid rgba(107,90,74,0.4);max-width:520px;width:100%;padding:1.4rem;animation:fadeIn 0.3s ease;}
.modal-hdr{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;padding-bottom:0.7rem;border-bottom:1px solid rgba(107,90,74,0.3);}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:1.25rem;font-style:italic;color:var(--parchment);}
.modal-x{background:none;border:none;color:var(--muted);font-size:1.1rem;cursor:pointer;font-family:'Courier Prime',monospace;padding:0.2rem 0.5rem;}
.modal-x:hover{color:var(--parchment);}
hr.d{border:none;height:1px;background:rgba(107,90,74,0.28);margin:1.2rem 0;}
.row-btns{display:flex;gap:0.5rem;flex-wrap:wrap;margin-top:1rem;}
/* BACKUP BAR */
.backup-bar{background:rgba(26,20,16,0.8);border-bottom:1px solid rgba(107,90,74,0.3);padding:0.5rem 1rem;display:flex;align-items:center;justify-content:space-between;gap:0.5rem;flex-wrap:wrap;}
.backup-status{font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.1em;color:var(--muted);}
.backup-status.fresh{color:var(--sage);}
.backup-btns{display:flex;gap:0.4rem;}
/* API KEY BANNER */
.api-banner{background:rgba(139,58,42,0.2);border:1px solid rgba(139,58,42,0.4);padding:0.8rem 1rem;margin-bottom:1rem;display:flex;align-items:center;gap:0.8rem;flex-wrap:wrap;}
.api-banner p{font-family:'Courier Prime',monospace;font-size:0.55rem;letter-spacing:0.1em;color:var(--dusty-rose);flex:1;}
.api-banner.hidden{display:none;}
</style>
</head>
<body>

<!-- BACKUP BAR -->
<div class="backup-bar">
  <span class="backup-status" id="backupStatus">â€” no backup yet</span>
  <div class="backup-btns">
    <button class="btn-g" onclick="exportData()" style="font-size:0.5rem;padding:0.3rem 0.6rem;">â¬‡ Export Backup</button>
    <label class="btn-g" style="font-size:0.5rem;padding:0.3rem 0.6rem;cursor:pointer;">â¬† Import Backup<input type="file" accept=".json" onchange="importData(this)" style="display:none;"></label>
    <button class="btn-g" onclick="showApiModal()" style="font-size:0.5rem;padding:0.3rem 0.6rem;">ðŸ”‘ API Key</button>
  </div>
</div>

<div class="header">
  <div class="weather-pill" id="weatherDisplay">â€”</div>
  <h1>WORN</h1>
  <p class="tagline">your closet. your logic. your story.</p>
</div>

<nav class="nav">
  <button class="nav-btn active" onclick="nav('closet',this)">Closet</button>
  <button class="nav-btn" onclick="nav('profile',this)">My Profile</button>
  <button class="nav-btn" onclick="nav('dressme',this)">Dress Me</button>
  <button class="nav-btn" onclick="nav('looks',this)">My Looks</button>
</nav>

<!-- API KEY BANNER (shows when no key set) -->
<div class="api-banner" id="apiBanner">
  <p>Dress Me needs an API key to work. Tap to add yours.</p>
  <button class="btn-g" onclick="showApiModal()" style="font-size:0.5rem;padding:0.3rem 0.7rem;">Add Key â†’</button>
</div>

<!-- CLOSET -->
<div class="section active" id="closet">
  <p class="sec-title">The Closet</p>
  <p class="sec-sub">every piece, every layer, everything</p>
  <div class="panel">
    <p class="ptitle-lg">Add a piece</p>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">Name / Description</label><input type="text" id="iName" placeholder="rust silk blouse, silver cuff, DM boots..."></div>
        <div class="fg"><label class="fl">Category</label>
          <select id="iCat" onchange="updateDynTags()">
            <option value="">â€” select â€”</option>
            <optgroup label="Clothing"><option>Top</option><option>Bottom</option><option>Dress</option><option>Outerwear</option><option>Modesty Layer</option></optgroup>
            <optgroup label="Footwear"><option>Shoes</option><option>Boots</option><option>Sandals</option><option>Sneakers</option></optgroup>
            <optgroup label="Jewelry"><option>Necklace</option><option>Earrings</option><option>Ring</option><option>Bracelet</option><option>Anklet</option><option>Body Jewelry</option><option>Hair Jewelry</option></optgroup>
            <optgroup label="Accessories"><option>Belt</option><option>Bag</option><option>Hat</option><option>Scarf</option><option>Socks / Tights</option><option>Sunglasses</option><option>Other</option></optgroup>
          </select>
        </div>
        <div class="fg"><label class="fl">Color(s)</label><input type="text" id="iColor" placeholder="rust, oxidized silver, deep burgundy..."></div>
        <div class="fg"><label class="fl">Where I found it</label><input type="text" id="iSource" placeholder="DI, Poshmark, gift..."></div>
      </div>
      <div>
        <label class="fl">Photos</label>
        <div class="photo-strip" id="photoStrip"></div>
        <p id="photoHint" style="font-family:'Courier Prime',monospace;font-size:0.48rem;letter-spacing:0.1em;color:var(--muted);margin-top:0.3rem;">select a category to see photo options</p>
      </div>
    </div>
    <div id="dynTags"></div>
    <div class="fg">
      <label class="fl">Occasions</label>
      <div class="tag-group" id="tOcc"><button class="tp" onclick="tog(this)">Everyday</button><button class="tp" onclick="tog(this)">Casual</button><button class="tp" onclick="tog(this)">Work</button><button class="tp" onclick="tog(this)">Church</button><button class="tp" onclick="tog(this)">Date</button><button class="tp" onclick="tog(this)">Party</button><button class="tp" onclick="tog(this)">Special occasion</button><button class="tp" onclick="tog(this)">Sleep / Lounge</button><button class="tp" onclick="tog(this)">Outdoor / Active</button><button class="tp" onclick="tog(this)">Winter layers</button></div>
    </div>
    <div class="fg">
      <label class="fl">Custom tags</label>
      <div class="ctag-wrap"><input type="text" id="ctagIn" placeholder="#witchy  #thrifted-DI  #grandma-chic..." onkeydown="if(event.key==='Enter'){addCtag();event.preventDefault();}"><button class="btn-g" onclick="addCtag()">+ Add</button></div>
      <div class="ctags" id="ctagDisplay"></div>
    </div>
    <div class="fg"><label class="fl">Notes</label><textarea id="iNotes" placeholder="fits loose in the shoulders, love the hardware, runs small..."></textarea></div>
    <div class="row-btns"><button class="btn-p" onclick="addItem()">Add to Closet</button><button class="btn-g" onclick="clearForm()">Clear</button></div>
  </div>
  <div class="search-bar"><input type="text" id="searchIn" placeholder="search name, tag, color, custom tag..." oninput="renderCloset()"></div>
  <div class="filter-bar">
    <button class="fbtn on" onclick="setF('all',this)">All</button>
    <button class="fbtn" onclick="setF('clothing',this)">Clothing</button>
    <button class="fbtn" onclick="setF('footwear',this)">Footwear</button>
    <button class="fbtn" onclick="setF('jewelry',this)">Jewelry</button>
    <button class="fbtn" onclick="setF('accessories',this)">Accessories</button>
  </div>
  <div class="closet-grid" id="closetGrid"></div>
</div>

<!-- PROFILE -->
<div class="section" id="profile">
  <p class="sec-title">My Profile</p>
  <p class="sec-sub">living document â€” update anytime</p>
  <div class="panel">
    <p class="ptitle">my reference photo</p>
    <div style="display:flex;gap:1rem;align-items:flex-start;">
      <div class="prof-photo-slot" id="profPhotoSlot">
        <input type="file" accept="image/*" onchange="setProfilePhoto(this)">
        <span style="font-size:1.5rem;position:relative;z-index:1;">ðŸªž</span>
        <span style="font-family:'Courier Prime',monospace;font-size:0.46rem;letter-spacing:0.09em;text-transform:uppercase;color:var(--muted);text-align:center;padding:0.3rem;line-height:1.5;position:relative;z-index:1;">me in white tee +<br>black bike shorts</span>
      </div>
      <p style="flex:1;font-family:'Libre Baskerville',serif;font-size:0.78rem;font-style:italic;color:var(--muted);line-height:1.7;">This is your baseline. Every item photographed on your body uses this as the reference â€” same outfit, same you, so every comparison is apples to apples. Update it anytime your body changes.</p>
    </div>
  </div>
  <div class="panel">
    <p class="ptitle">style quiz â€” pick everything that feels true, not aspirational</p>
    <div class="quiz-q"><p class="quiz-qt">When I walk into a thrift store, I'm drawn to...</p><div class="qopts" id="qDraw"><button class="qo" onclick="tog(this)">pieces with history</button><button class="qo" onclick="tog(this)">unexpected textures</button><button class="qo" onclick="tog(this)">anything that feels found</button><button class="qo" onclick="tog(this)">things no one else has</button><button class="qo" onclick="tog(this)">structured classics</button><button class="qo" onclick="tog(this)">soft romantic pieces</button><button class="qo" onclick="tog(this)">dark and moody tones</button><button class="qo" onclick="tog(this)">anything witchy or mystical</button></div></div>
    <div class="quiz-q"><p class="quiz-qt">The energy I want my outfits to give off...</p><div class="qopts" id="qEnergy"><button class="qo" onclick="tog(this)">quietly magnetic</button><button class="qo" onclick="tog(this)">grounded and real</button><button class="qo" onclick="tog(this)">romantic with an edge</button><button class="qo" onclick="tog(this)">slightly dangerous</button><button class="qo" onclick="tog(this)">effortlessly cool</button><button class="qo" onclick="tog(this)">soft authority</button><button class="qo" onclick="tog(this)">unexpected and earned</button><button class="qo" onclick="tog(this)">undeniably myself</button></div></div>
    <div class="quiz-q"><p class="quiz-qt">My style leans toward...</p><div class="qopts" id="qLean"><button class="qo" onclick="tog(this)">thrifted / found</button><button class="qo" onclick="tog(this)">vintage-coded</button><button class="qo" onclick="tog(this)">witchy / dark</button><button class="qo" onclick="tog(this)">edgy / unexpected</button><button class="qo" onclick="tog(this)">quietly sexy</button><button class="qo" onclick="tog(this)">romantic / soft</button><button class="qo" onclick="tog(this)">grounded / earthy</button><button class="qo" onclick="tog(this)">eclectic / mixed</button><button class="qo" onclick="tog(this)">slightly rugged</button><button class="qo" onclick="tog(this)">cottagecore adjacent</button></div></div>
    <div class="quiz-q"><p class="quiz-qt">Outfits fail for me when they feel...</p><div class="qopts" id="qFail"><button class="qo" onclick="tog(this)">too try-hard</button><button class="qo" onclick="tog(this)">too costume-y</button><button class="qo" onclick="tog(this)">too matchy-matchy</button><button class="qo" onclick="tog(this)">too safe / boring</button><button class="qo" onclick="tog(this)">too trendy</button><button class="qo" onclick="tog(this)">too girlish / sweet</button><button class="qo" onclick="tog(this)">nothing grounds it</button><button class="qo" onclick="tog(this)">no surprise element</button></div></div>
    <div class="quiz-q"><p class="quiz-qt">My style icons or references...</p><input type="text" id="qIcons" placeholder="anyone real, fictional, aesthetic accounts, vibes, eras..."></div>
  </div>
  <div class="panel">
    <p class="ptitle">style poles â€” where do you land today?</p>
    <div class="pole-row"><span class="plbl">Soft</span><input type="range" class="pole-slider" id="pSS" min="0" max="100" value="35"><span class="plbl r">Structured</span></div>
    <div class="pole-row"><span class="plbl">Romantic</span><input type="range" class="pole-slider" id="pRS" min="0" max="100" value="30"><span class="plbl r">Severe</span></div>
    <div class="pole-row"><span class="plbl">Vintage</span><input type="range" class="pole-slider" id="pVM" min="0" max="100" value="25"><span class="plbl r">Modern</span></div>
    <div class="pole-row"><span class="plbl">Quiet</span><input type="range" class="pole-slider" id="pQV" min="0" max="100" value="40"><span class="plbl r">Visible</span></div>
    <div class="pole-row"><span class="plbl">Playful</span><input type="range" class="pole-slider" id="pPA" min="0" max="100" value="45"><span class="plbl r">Authority</span></div>
  </div>
  <div class="panel">
    <p class="ptitle">my body</p>
    <div class="g2">
      <div class="fg"><label class="fl">I love showing off</label><input type="text" id="bLove" placeholder="collarbone, waist, arms..."></div>
      <div class="fg"><label class="fl">I prefer to downplay</label><input type="text" id="bDown" placeholder="hips, midsection..."></div>
    </div>
    <div class="fg"><label class="fl">Notes for my stylist</label><textarea id="bNotes" placeholder="how I like silhouettes to fit, what tends not to work..."></textarea></div>
    <hr class="d">
    <p class="ptitle" style="margin-bottom:0.8rem;">measurements</p>
    <div class="meas-grid">
      <div class="mf"><label>Height</label><input type="text" id="mH" placeholder='5&apos;6"'></div>
      <div class="mf"><label>Weight</label><input type="text" id="mW" placeholder="optional"></div>
      <div class="mf"><label>Bust</label><input type="text" id="mB" placeholder='36"'></div>
      <div class="mf"><label>Waist</label><input type="text" id="mWa" placeholder='28"'></div>
      <div class="mf"><label>Hips</label><input type="text" id="mHi" placeholder='38"'></div>
      <div class="mf"><label>Inseam</label><input type="text" id="mI" placeholder='30"'></div>
      <div class="mf"><label>Dress size</label><input type="text" id="mD" placeholder="8 / M"></div>
      <div class="mf"><label>Shoe size</label><input type="text" id="mS" placeholder="8.5"></div>
    </div>
  </div>
  <div class="panel">
    <p class="ptitle">dressing preferences</p>
    <div class="fg"><label class="fl">Religious / modesty garments</label>
      <div class="tag-group" id="tMod"><button class="tp" onclick="sel(this,'tMod')">Daily garments</button><button class="tp" onclick="sel(this,'tMod')">Sometimes</button><button class="tp" onclick="sel(this,'tMod')">Not currently</button></div>
    </div>
    <div class="fg" style="margin-top:0.8rem;"><label class="fl">Occasions I dress for</label>
      <div class="tag-group" id="tOccP"><button class="tp" onclick="tog(this)">Everyday</button><button class="tp" onclick="tog(this)">Work</button><button class="tp" onclick="tog(this)">Church</button><button class="tp" onclick="tog(this)">Date</button><button class="tp" onclick="tog(this)">Social</button><button class="tp" onclick="tog(this)">Running errands</button><button class="tp" onclick="tog(this)">Special occasion</button><button class="tp" onclick="tog(this)">Cozy / home</button></div>
    </div>
  </div>
  <div class="panel">
    <p class="ptitle">location & climate</p>
    <div class="g2">
      <div class="fg"><label class="fl">City / Region</label><input type="text" id="uLoc" placeholder="Salt Lake City, Utah"></div>
      <div class="fg"><label class="fl">Current Season</label><select id="uSea"><option>Winter</option><option>Spring</option><option>Summer</option><option>Fall</option></select></div>
    </div>
    <div class="fg"><label class="fl">Climate notes</label><textarea id="uClim" placeholder="big temperature swings, layering essential..." style="min-height:55px;"></textarea></div>
  </div>
  <div class="panel">
    <p class="ptitle">thrift wishlist</p>
    <p style="font-family:'Cormorant Garamond',serif;font-size:0.82rem;font-style:italic;color:var(--muted);margin-bottom:0.8rem;">pieces the AI says would unlock your closet â€” plus your own hunts</p>
    <div id="thriftEl"></div>
    <div style="display:flex;gap:0.5rem;margin-top:0.8rem;"><input type="text" id="thriftIn" placeholder="add your own..." style="flex:1;"><button class="btn-g" onclick="addThrift()">+ Add</button></div>
  </div>
  <div class="traj-box"><div class="traj-lbl">wardrobe trajectory</div><div class="traj-txt" id="trajTxt">Your style direction will emerge as you log more looks. Keep going.</div></div>
  <div class="row-btns" style="margin-top:1.5rem;"><button class="btn-p" onclick="saveProfile()">Save Profile</button></div>
</div>

<!-- DRESS ME -->
<div class="section" id="dressme">
  <p class="sec-title">Dress Me</p>
  <p class="sec-sub">head to toe, built for right now</p>
  <div class="panel">
    <div class="fg"><label class="fl">How are you feeling right now?</label>
      <div class="mood-grid"><button class="mbtn" onclick="selM(this)">tender</button><button class="mbtn" onclick="selM(this)">strong</button><button class="mbtn" onclick="selM(this)">restless</button><button class="mbtn" onclick="selM(this)">low-key</button><button class="mbtn" onclick="selM(this)">playful</button><button class="mbtn" onclick="selM(this)">fierce</button><button class="mbtn" onclick="selM(this)">foggy</button><button class="mbtn" onclick="selM(this)">magnetic</button><button class="mbtn" onclick="selM(this)">just existing</button></div>
    </div>
    <div class="fg" style="margin-top:0.9rem;"><label class="fl">What do you need from this outfit?</label>
      <div class="intent-row"><button class="ibtn" onclick="selI(this)" data-i="regulate">regulate me</button><button class="ibtn" onclick="selI(this)" data-i="express">express me</button><button class="ibtn" onclick="selI(this)" data-i="protect">protect me</button></div>
    </div>
    <div class="fg" style="margin-top:0.9rem;"><label class="fl">Occasion</label>
      <select id="dmOcc"><option value="">â€” any â€”</option><option>Everyday</option><option>Casual</option><option>Work</option><option>Church</option><option>Date</option><option>Party</option><option>Special occasion</option><option>Running errands</option><option>Cozy / home</option></select>
    </div>
    <div style="margin-top:1.1rem;"><button class="btn-p" onclick="buildOutfit()" id="dmBtn" style="width:100%;padding:0.85rem;">Build My Outfit â†’</button></div>
  </div>
  <div class="spinner" id="spinner"><span class="dots">reading your closet and finding the tension...</span></div>
  <div class="outfit-out" id="outfitOut">
    <div class="out-name" id="outName"></div>
    <div class="out-expl" id="outExpl"></div>
    <div class="flat-lay" id="flatLay"></div>
    <div id="outPieces"></div>
    <div class="thrift-box" id="thriftBox" style="display:none;"></div>
    <div class="row-btns" style="margin-top:1.3rem;"><button class="btn-s" onclick="buildOutfit()">Try another â†’</button><button class="btn-g" onclick="sendToLooks()">Save to My Looks</button></div>
  </div>
  <div class="empty" id="dmEmpty" style="display:none;"><div class="empty-ico">ðŸ‘—</div><p class="empty-txt">Add at least a few pieces to your closet first.<br>The more you add, the better the magic.</p></div>
</div>

<!-- MY LOOKS -->
<div class="section" id="looks">
  <p class="sec-title">My Looks</p>
  <p class="sec-sub">the record of you</p>
  <div class="panel">
    <p class="ptitle-lg">Log a look</p>
    <div class="g2">
      <div>
        <div class="fg"><label class="fl">Outfit Name</label><input type="text" id="lName" placeholder="grounded romance, found sunday..."></div>
        <div class="fg"><label class="fl">Date Worn</label><input type="text" id="lDate"></div>
        <div class="fg"><label class="fl">What I wore</label><textarea id="lItems" placeholder="rust blazer + white tee + levi's + brown boots + layered chains..." style="min-height:60px;"></textarea></div>
      </div>
      <div>
        <div class="photo-strip">
          <div class="pslot" id="lSlot1"><input type="file" accept="image/*" onchange="slotPhoto(this,'lSlot1')"><span class="sico">ðŸ“·</span><span class="slbl">outfit photo</span></div>
          <div class="pslot" id="lSlot2"><input type="file" accept="image/*" onchange="slotPhoto(this,'lSlot2')"><span class="sico">ðŸ¤³</span><span class="slbl">selfie / detail</span></div>
        </div>
      </div>
    </div>
    <div class="fg"><label class="fl">How did it feel?</label>
      <div class="react-grid">
        <button class="rbtn win" onclick="this.classList.toggle('on')">âœ“ felt like me</button>
        <button class="rbtn win" onclick="this.classList.toggle('on')">âœ“ felt powerful</button>
        <button class="rbtn win" onclick="this.classList.toggle('on')">âœ“ effortless</button>
        <button class="rbtn win" onclick="this.classList.toggle('on')">âœ“ got compliments</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">âœ— proportion off</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">âœ— try-hard</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">âœ— too soft / floaty</button>
        <button class="rbtn miss" onclick="this.classList.toggle('on')">âœ— felt costume-y</button>
        <button class="rbtn neu" onclick="this.classList.toggle('on')">~ better in mirror</button>
        <button class="rbtn neu" onclick="this.classList.toggle('on')">~ better in photos</button>
      </div>
    </div>
    <div class="fg" style="margin-top:0.8rem;"><label class="fl">Notes to self</label><textarea id="lNotes" placeholder="what worked, what I'd change, what surprised me..."></textarea></div>
    <button class="btn-p" onclick="logLook()" style="margin-top:0.9rem;">Save to Journal</button>
  </div>
  <div class="looks-grid" id="looksGrid"></div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="itemModal">
  <div class="modal">
    <div class="modal-hdr"><span class="modal-title" id="mName">â€”</span><button class="modal-x" onclick="closeModal('itemModal')">âœ•</button></div>
    <div id="mPhotoStrip" style="display:flex;gap:0.5rem;margin-bottom:1rem;"></div>
    <div id="mDetails" style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-bottom:0.5rem;"></div>
    <div class="ctags" id="mCtags" style="margin-bottom:0.6rem;"></div>
    <div style="font-family:'Libre Baskerville',serif;font-size:0.78rem;color:var(--muted);font-style:italic;margin-bottom:1rem;" id="mNotes"></div>
    <div class="row-btns"><button class="btn-g" style="color:var(--rust);border-color:rgba(139,58,42,0.4);" onclick="deleteItem()">Remove piece</button></div>
  </div>
</div>

<!-- API KEY MODAL -->
<div class="modal-overlay" id="apiModal">
  <div class="modal">
    <div class="modal-hdr"><span class="modal-title">API Key</span><button class="modal-x" onclick="closeModal('apiModal')">âœ•</button></div>
    <p style="font-family:'Libre Baskerville',serif;font-size:0.8rem;color:var(--muted);font-style:italic;line-height:1.7;margin-bottom:1rem;">Your API key powers Dress Me. It's stored only on your device â€” never sent anywhere except directly to Anthropic when you request an outfit.</p>
    <div class="fg">
      <label class="fl">Anthropic API Key</label>
      <input type="password" id="apiKeyInput" placeholder="sk-ant-...">
    </div>
    <p style="font-family:'Courier Prime',monospace;font-size:0.52rem;letter-spacing:0.1em;color:var(--muted);margin-bottom:1rem;">Don't have one? Go to <strong style="color:var(--aged-gold);">console.anthropic.com</strong> â†’ sign up free â†’ API Keys â†’ Create Key</p>
    <div class="row-btns">
      <button class="btn-p" onclick="saveApiKey()">Save Key</button>
      <button class="btn-g" onclick="closeModal('apiModal')">Cancel</button>
    </div>
  </div>
</div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let closet=[],looks=[],profile={},thriftList=[];
let curItem=null,lastOutfit=null,selMood='',selIntent='',activeF='all',pendingCtags=[];
const LS={
  get:(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d;}catch{return d;}},
  set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}}
};

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('load',()=>{
  closet=LS.get('w_closet',[]);
  looks=LS.get('w_looks',[]);
  profile=LS.get('w_profile',{});
  thriftList=LS.get('w_thrift',[]);
  loadProfile();renderCloset();renderLooks();renderThrift();updateWeather();updateTraj();
  document.getElementById('lDate').value=new Date().toLocaleDateString();
  checkApiKey();
  updateBackupStatus();
});

// â”€â”€ BACKUP / EXPORT / IMPORT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function exportData(){
  const data={
    version:1,
    exported:new Date().toISOString(),
    closet,looks,profile,thriftList
  };
  // Strip photos from export to keep file size manageable â€” warn user
  const hasPhotos=closet.some(i=>i.photos?.some(p=>p))||looks.some(l=>l.photos?.length)||profile.photo;
  const payload=JSON.stringify(data);
  const blob=new Blob([payload],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`worn-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  LS.set('w_lastBackup',new Date().toISOString());
  updateBackupStatus();
}

function importData(input){
  if(!input.files[0])return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const data=JSON.parse(e.target.result);
      if(!data.version){alert('This doesn\'t look like a Worn backup file.');return;}
      if(!confirm(`This will replace your current data with the backup from ${data.exported?.slice(0,10)||'unknown date'}. Are you sure?`))return;
      if(data.closet)closet=data.closet;
      if(data.looks)looks=data.looks;
      if(data.profile)profile=data.profile;
      if(data.thriftList)thriftList=data.thriftList;
      LS.set('w_closet',closet);LS.set('w_looks',looks);LS.set('w_profile',profile);LS.set('w_thrift',thriftList);
      loadProfile();renderCloset();renderLooks();renderThrift();updateWeather();updateTraj();
      alert('âœ“ Backup restored successfully. Welcome back.');
    }catch(err){alert('Could not read that file. Make sure it\'s a Worn backup JSON.');}
  };
  reader.readAsText(input.files[0]);
  input.value='';
}

function updateBackupStatus(){
  const last=LS.get('w_lastBackup',null);
  const el=document.getElementById('backupStatus');
  if(!last){el.textContent='â€” no backup yet';el.className='backup-status';return;}
  const d=new Date(last);const now=new Date();
  const days=Math.floor((now-d)/(1000*60*60*24));
  if(days===0){el.textContent='âœ“ backed up today';el.className='backup-status fresh';}
  else if(days===1){el.textContent='backed up yesterday';el.className='backup-status';}
  else{el.textContent=`backed up ${days} days ago`;el.className='backup-status';}
}

// â”€â”€ API KEY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showApiModal(){
  const existing=LS.get('w_apikey','');
  if(existing)document.getElementById('apiKeyInput').value=existing;
  document.getElementById('apiModal').classList.add('open');
}

function saveApiKey(){
  const key=document.getElementById('apiKeyInput').value.trim();
  if(!key){alert('Enter an API key.');return;}
  LS.set('w_apikey',key);
  closeModal('apiModal');
  checkApiKey();
  alert('âœ“ API key saved. Dress Me is ready.');
}

function checkApiKey(){
  const key=LS.get('w_apikey','');
  const banner=document.getElementById('apiBanner');
  if(banner)banner.className=key?'api-banner hidden':'api-banner';
}

function getApiKey(){return LS.get('w_apikey','');}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function nav(id,btn){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');btn.classList.add('active');
  if(id==='dressme')checkDM();
}

// â”€â”€ TAG HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sel(btn,grp){document.querySelectorAll(`#${grp} .tp`).forEach(b=>b.classList.remove('on'));btn.classList.add('on');}
function tog(btn){btn.classList.toggle('on');}
function getOne(grp){const s=document.querySelector(`#${grp} .tp.on`);return s?s.textContent:'';}
function getMany(grp){return[...document.querySelectorAll(`#${grp} .tp.on`)].map(b=>b.textContent);}

// â”€â”€ CUSTOM TAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addCtag(){
  const inp=document.getElementById('ctagIn');
  const v=inp.value.trim().replace(/^#/,'');
  if(!v||pendingCtags.includes(v)){inp.value='';return;}
  pendingCtags.push(v);renderCtags();inp.value='';
}
function renderCtags(){
  document.getElementById('ctagDisplay').innerHTML=pendingCtags.map((t,i)=>`<span class="ctag">#${t}<span class="ctx" onclick="rmCtag(${i})">Ã—</span></span>`).join('');
}
function rmCtag(i){pendingCtags.splice(i,1);renderCtags();}

// â”€â”€ DYNAMIC TAGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CTAGS={
  clothing:{Structure:['Soft','Balanced','Structured'],'Visual Weight':['Light','Medium','Heavy'],Energy:['Romantic','Grounded','Edgy','Playful','Neutral'],'Role in Outfit':['Core','Anchor','Support','Accent'],'Era Signal':['Vintage-coded','Timeless','Modern']},
  footwear:{Structure:['Soft','Structured'],Energy:['Grounded','Edgy','Romantic','Neutral'],'Role in Outfit':['Anchor','Support','Statement'],Season:['All season','Spring/Fall','Summer','Winter/Snow']},
  jewelry:{Metal:['Gold','Silver','Oxidized silver','Mixed metals','Brass','No metal'],Style:['Delicate','Chunky','Vintage','Witchy','Minimalist','Statement','Layering piece'],Weight:['Delicate','Medium','Statement'],Energy:['Romantic','Edgy','Grounded','Mystical']},
  accessories:{Structure:['Soft','Structured'],'Visual Weight':['Light','Medium','Heavy'],Energy:['Romantic','Grounded','Edgy','Neutral'],'Role in Outfit':['Anchor','Support','Accent','Statement']}
};
const CGRPS={clothing:['Top','Bottom','Dress','Outerwear','Modesty Layer'],footwear:['Shoes','Boots','Sandals','Sneakers'],jewelry:['Necklace','Earrings','Ring','Bracelet','Anklet','Body Jewelry','Hair Jewelry'],accessories:['Belt','Bag','Hat','Scarf','Socks / Tights','Sunglasses','Other']};
const CPHOTOS={clothing:[{l:'piece alone',i:'ðŸ“¸'},{l:'on base (white tee + bike shorts)',i:'ðŸªž'},{l:'worn in the wild',i:'âœ¨'}],footwear:[{l:'piece alone',i:'ðŸ“¸'},{l:'on your leg/foot',i:'ðŸ¦¶'},{l:'in a full outfit',i:'âœ¨'}],jewelry:[{l:'piece alone',i:'ðŸ“¸'},{l:'worn on you',i:'ðŸ’Ž'},{l:'in a full look',i:'âœ¨'}],accessories:[{l:'piece alone',i:'ðŸ“¸'},{l:'worn / styled',i:'ðŸªž'},{l:'in a full outfit',i:'âœ¨'}]};
function getCG(cat){for(const[g,cs]of Object.entries(CGRPS)){if(cs.includes(cat))return g;}return 'clothing';}

function updateDynTags(){
  const cat=document.getElementById('iCat').value;const g=getCG(cat);
  const td=CTAGS[g]||CTAGS.clothing;const ph=CPHOTOS[g]||CPHOTOS.clothing;
  document.getElementById('dynTags').innerHTML=Object.entries(td).map(([lbl,opts])=>`<div class="fg"><label class="fl">${lbl}</label><div class="tag-group" id="dyn_${lbl.replace(/\s/g,'_')}">${opts.map(o=>`<button class="tp" onclick="sel(this,'dyn_${lbl.replace(/\s/g,'_')}')">${o}</button>`).join('')}</div></div>`).join('');
  const strip=document.getElementById('photoStrip');const hint=document.getElementById('photoHint');
  if(!cat){strip.innerHTML='';hint.style.display='block';return;}
  hint.style.display='none';
  strip.innerHTML=ph.map((p,idx)=>`<div class="pslot" id="aSlot${idx}"><input type="file" accept="image/*" onchange="slotPhoto(this,'aSlot${idx}')"><span class="sico">${p.i}</span><span class="slbl">${p.l}</span></div>`).join('');
}

function slotPhoto(input,slotId){
  if(!input.files[0])return;
  const r=new FileReader();r.onload=e=>{
    const s=document.getElementById(slotId);if(!s)return;
    let img=s.querySelector('img');if(!img){img=document.createElement('img');s.appendChild(img);}
    img.src=e.target.result;s.classList.add('hi');s.dataset.img=e.target.result;
  };r.readAsDataURL(input.files[0]);
}

// â”€â”€ ADD ITEM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addItem(){
  const name=document.getElementById('iName').value.trim();const cat=document.getElementById('iCat').value;
  if(!name){alert('Give the piece a name.');return;}if(!cat){alert('Select a category.');return;}
  const g=getCG(cat);const td=CTAGS[g]||CTAGS.clothing;
  const dynTags={};Object.keys(td).forEach(lbl=>{dynTags[lbl]=getOne('dyn_'+lbl.replace(/\s/g,'_'));});
  const photos=[0,1,2].map(i=>{const s=document.getElementById(`aSlot${i}`);return s?.dataset?.img||'';});
  const item={id:Date.now(),name,cat,grp:g,color:document.getElementById('iColor').value,source:document.getElementById('iSource').value,dynTags,occasions:getMany('tOcc'),customTags:[...pendingCtags],notes:document.getElementById('iNotes').value,photos,wearCount:0,dateAdded:new Date().toLocaleDateString()};
  closet.push(item);LS.set('w_closet',closet);renderCloset();clearForm();
}

function clearForm(){
  ['iName','iColor','iSource','iNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('iCat').value='';
  document.querySelectorAll('#tOcc .tp').forEach(t=>t.classList.remove('on'));
  pendingCtags=[];renderCtags();document.getElementById('photoStrip').innerHTML='';
  document.getElementById('photoHint').style.display='block';document.getElementById('dynTags').innerHTML='';
  document.getElementById('ctagIn').value='';
}

// â”€â”€ FILTER/SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setF(f,btn){activeF=f;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');renderCloset();}
function filtered(){
  const q=(document.getElementById('searchIn')?.value||'').toLowerCase();
  return closet.filter(item=>{
    const gm=activeF==='all'||item.grp===activeF;if(!gm)return false;
    if(!q)return true;
    return[item.name,item.color,item.cat,item.source,...(item.occasions||[]),...(item.customTags||[]),item.notes,...Object.values(item.dynTags||{})].join(' ').toLowerCase().includes(q);
  });
}

// â”€â”€ RENDER CLOSET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ICONS={Top:'ðŸ‘•',Bottom:'ðŸ‘–',Dress:'ðŸ‘—',Outerwear:'ðŸ§¥','Modesty Layer':'ðŸ«¶',Shoes:'ðŸ‘Ÿ',Boots:'ðŸ¥¾',Sandals:'ðŸ‘¡',Sneakers:'ðŸ‘Ÿ',Necklace:'ðŸ“¿',Earrings:'ðŸ’Ž',Ring:'ðŸ’',Bracelet:'âœ¨',Anklet:'âœ¨','Body Jewelry':'ðŸ’«','Hair Jewelry':'ðŸŒ¸',Belt:'ðŸª¢',Bag:'ðŸ‘œ',Hat:'ðŸŽ©',Scarf:'ðŸ§£','Socks / Tights':'ðŸ§¦',Sunglasses:'ðŸ•¶ï¸',Other:'ðŸª¡'};
function ico(cat){return ICONS[cat]||'ðŸª¡';}

function renderCloset(){
  const grid=document.getElementById('closetGrid');const items=filtered();
  if(!items.length){grid.innerHTML=`<div class="empty"><div class="empty-ico">ðŸ§¥</div><p class="empty-txt">${closet.length?'No pieces match that filter.':'Your closet is empty.<br>Add your first piece above.'}</p></div>`;return;}
  grid.innerHTML=items.map(item=>`<div class="ccard" onclick="openItem(${item.id})">${item.photos?.[0]?`<img class="ccard-img" src="${item.photos[0]}" loading="lazy">`:`<div class="ccard-ph">${ico(item.cat)}</div>`}<div class="ccard-info"><div class="ccard-name">${item.name}</div><div class="ccard-tags">${item.dynTags?.['Role in Outfit']?`<span class="mt ${item.dynTags['Role in Outfit']==='Anchor'?'anc':item.dynTags['Role in Outfit']==='Core'?'cor':''}">${item.dynTags['Role in Outfit']}</span>`:''} ${item.dynTags?.['Energy']?`<span class="mt">${item.dynTags['Energy']}</span>`:''} ${(item.occasions||[]).slice(0,1).map(o=>`<span class="mt occ">${o}</span>`).join('')} ${(item.customTags||[]).slice(0,2).map(t=>`<span class="mt cus">#${t}</span>`).join('')}</div></div></div>`).join('');
}

// â”€â”€ ITEM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openItem(id){
  curItem=closet.find(i=>i.id===id);if(!curItem)return;
  document.getElementById('mName').textContent=curItem.name;
  const ph=CPHOTOS[curItem.grp]||CPHOTOS.clothing;
  document.getElementById('mPhotoStrip').innerHTML=ph.map((p,i)=>`<div class="pslot" style="flex:1;" id="ms${i}"><input type="file" accept="image/*" onchange="updPhoto(this,${i})">${curItem.photos?.[i]?`<img src="${curItem.photos[i]}">`:''}  <span class="sico">${p.i}</span><span class="slbl">${p.l}</span></div>`).join('');
  curItem.photos?.forEach((p,i)=>{if(p)document.getElementById(`ms${i}`)?.classList.add('hi');});
  document.getElementById('mDetails').innerHTML=[`<span class="mt">${curItem.cat}</span>`,curItem.color?`<span class="mt">${curItem.color}</span>`:'', ...Object.entries(curItem.dynTags||{}).filter(([,v])=>v).map(([,v])=>`<span class="mt">${v}</span>`),...(curItem.occasions||[]).map(o=>`<span class="mt occ">${o}</span>`)].join('');
  document.getElementById('mCtags').innerHTML=(curItem.customTags||[]).map(t=>`<span class="ctag">#${t}</span>`).join('');
  document.getElementById('mNotes').textContent=curItem.notes||'';
  document.getElementById('itemModal').classList.add('open');
}

function updPhoto(input,idx){
  if(!curItem||!input.files[0])return;
  const r=new FileReader();r.onload=e=>{if(!curItem.photos)curItem.photos=[];curItem.photos[idx]=e.target.result;LS.set('w_closet',closet);openItem(curItem.id);renderCloset();};r.readAsDataURL(input.files[0]);
}

function deleteItem(){
  if(!curItem||!confirm(`Remove "${curItem.name}"?`))return;
  closet=closet.filter(i=>i.id!==curItem.id);LS.set('w_closet',closet);renderCloset();closeModal('itemModal');
}

function closeModal(id){document.getElementById(id).classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))closeModal(e.target.id);});

// â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveProfile(){
  profile={photo:profile.photo||'',quiz:{drawn:getMany('qDraw'),energy:getMany('qEnergy'),lean:getMany('qLean'),fail:getMany('qFail'),icons:document.getElementById('qIcons').value},poles:{ss:document.getElementById('pSS').value,rs:document.getElementById('pRS').value,vm:document.getElementById('pVM').value,qv:document.getElementById('pQV').value,pa:document.getElementById('pPA').value},body:{love:document.getElementById('bLove').value,down:document.getElementById('bDown').value,notes:document.getElementById('bNotes').value,height:document.getElementById('mH').value,weight:document.getElementById('mW').value,bust:document.getElementById('mB').value,waist:document.getElementById('mWa').value,hips:document.getElementById('mHi').value,inseam:document.getElementById('mI').value,dress:document.getElementById('mD').value,shoe:document.getElementById('mS').value},modesty:getOne('tMod'),occasions:getMany('tOccP'),location:document.getElementById('uLoc').value,season:document.getElementById('uSea').value,climate:document.getElementById('uClim').value};
  LS.set('w_profile',profile);
  const btn=document.querySelector('#profile .btn-p');btn.textContent='Saved âœ“';setTimeout(()=>btn.textContent='Save Profile',2000);
  updateWeather();
}

function setProfilePhoto(input){
  if(!input.files[0])return;
  const r=new FileReader();r.onload=e=>{
    profile.photo=e.target.result;LS.set('w_profile',profile);
    const s=document.getElementById('profPhotoSlot');let img=s.querySelector('img');
    if(!img){img=document.createElement('img');s.appendChild(img);}img.src=e.target.result;
  };r.readAsDataURL(input.files[0]);
}

function loadProfile(){
  if(!profile||!Object.keys(profile).length)return;
  if(profile.quiz){
    const sm=(grp,vals)=>vals?.forEach(v=>document.querySelectorAll(`#${grp} .qo`).forEach(b=>{if(b.textContent===v)b.classList.add('on');}));
    sm('qDraw',profile.quiz.drawn);sm('qEnergy',profile.quiz.energy);sm('qLean',profile.quiz.lean);sm('qFail',profile.quiz.fail);
    if(profile.quiz.icons)document.getElementById('qIcons').value=profile.quiz.icons;
  }
  if(profile.poles){['ss','rs','vm','qv','pa'].forEach(k=>{const el=document.getElementById('p'+k.toUpperCase());if(el&&profile.poles[k])el.value=profile.poles[k];});}
  if(profile.body){const b=profile.body;[['bLove','love'],['bDown','down'],['bNotes','notes'],['mH','height'],['mW','weight'],['mB','bust'],['mWa','waist'],['mHi','hips'],['mI','inseam'],['mD','dress'],['mS','shoe']].forEach(([id,key])=>{const el=document.getElementById(id);if(el&&b[key])el.value=b[key];});}
  if(profile.modesty)document.querySelectorAll('#tMod .tp').forEach(b=>{if(b.textContent===profile.modesty)b.classList.add('on');});
  if(profile.occasions)profile.occasions.forEach(v=>document.querySelectorAll('#tOccP .tp').forEach(b=>{if(b.textContent===v)b.classList.add('on');}));
  if(profile.location)document.getElementById('uLoc').value=profile.location;
  if(profile.season)document.getElementById('uSea').value=profile.season;
  if(profile.climate)document.getElementById('uClim').value=profile.climate;
  if(profile.photo){const s=document.getElementById('profPhotoSlot');let img=s.querySelector('img');if(!img){img=document.createElement('img');s.appendChild(img);}img.src=profile.photo;}
}

// â”€â”€ THRIFT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addThrift(){const v=document.getElementById('thriftIn').value.trim();if(!v)return;thriftList.push(v);LS.set('w_thrift',thriftList);renderThrift();document.getElementById('thriftIn').value='';}
function renderThrift(){const el=document.getElementById('thriftEl');if(!thriftList.length){el.innerHTML=`<p style="font-family:'Courier Prime',monospace;font-size:0.58rem;letter-spacing:0.1em;color:var(--muted);">nothing yet</p>`;return;}el.innerHTML=thriftList.map((t,i)=>`<div style="display:flex;align-items:center;gap:0.5rem;padding:0.38rem 0;border-bottom:1px solid rgba(107,90,74,0.18);"><span style="font-family:'Cormorant Garamond',serif;font-size:0.85rem;color:var(--cream);flex:1;">â—¦ ${t}</span><button onclick="rmThrift(${i})" style="font-family:'Courier Prime',monospace;font-size:0.55rem;color:var(--muted);background:none;border:none;cursor:pointer;">âœ•</button></div>`).join('');}
function rmThrift(i){thriftList.splice(i,1);LS.set('w_thrift',thriftList);renderThrift();}

// â”€â”€ DRESS ME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selM(btn){document.querySelectorAll('.mbtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');selMood=btn.textContent;}
function selI(btn){document.querySelectorAll('.ibtn').forEach(b=>b.classList.remove('on'));btn.classList.add('on');selIntent=btn.dataset.i;}
function checkDM(){const e=document.getElementById('dmEmpty');const b=document.getElementById('dmBtn');if(closet.length<3){e.style.display='block';b.disabled=true;}else{e.style.display='none';b.disabled=false;}}

async function buildOutfit(){
  if(closet.length<3)return;
  const apiKey=getApiKey();
  if(!apiKey){showApiModal();return;}
  document.getElementById('outfitOut').classList.remove('show');
  document.getElementById('spinner').classList.add('show');
  document.getElementById('dmBtn').disabled=true;

  const byGrp={};closet.forEach(item=>{if(!byGrp[item.grp])byGrp[item.grp]=[];byGrp[item.grp].push(item);});
  const closetStr=Object.entries(byGrp).map(([g,items])=>`[${g.toUpperCase()}]\n${items.map(i=>{const tags=Object.entries(i.dynTags||{}).filter(([,v])=>v).map(([k,v])=>`${k}:${v}`).join('|');const ct=(i.customTags||[]).map(t=>`#${t}`).join(' ');return`  â€¢ ${i.name} (${i.cat}) | color:${i.color||'?'} | ${tags} | occasions:${(i.occasions||[]).join(',')||'any'} | ${ct}`;}).join('\n')}`).join('\n\n');

  const prof=`Style quiz leans: ${profile.quiz?.lean?.join(', ')||'not set'}
Wants energy: ${profile.quiz?.energy?.join(', ')||'not set'}
Drawn to: ${profile.quiz?.drawn?.join(', ')||'not set'}
Fails when: ${profile.quiz?.fail?.join(', ')||'not set'}
Icons: ${profile.quiz?.icons||'none'}
Poles(0=left,100=right): softâ†’structured:${profile.poles?.ss||50} | romanticâ†’severe:${profile.poles?.rs||30} | vintageâ†’modern:${profile.poles?.vm||25}
Body loves: ${profile.body?.love||'not specified'} | Downplay: ${profile.body?.down||'not specified'}
Body notes: ${profile.body?.notes||'none'}
Measurements: height:${profile.body?.height||'?'} bust:${profile.body?.bust||'?'} waist:${profile.body?.waist||'?'} hips:${profile.body?.hips||'?'} shoe:${profile.body?.shoe||'?'}
Modesty: ${profile.modesty||'not specified'}
Location: ${profile.location||'Utah'} | Season: ${profile.season||'Winter'} | Climate: ${profile.climate||'variable, layering essential'}`;

  const hist=looks.length?looks.slice(0,5).map(l=>`  "${l.name}": ${l.items} | wins:${(l.wins||[]).join(',')} | misses:${(l.misses||[]).join(',')}`).join('\n'):'No history yet.';

  const prompt=`You are Worn â€” Heather's deeply personal AI stylist. You know her exact style DNA.

HEATHER'S STYLE TRUTH:
She dresses by instinct. Clothes that feel found, not assembled. Vintage-driven, thrifted, romantic but grounded. Soft + structured, feminine + edgy. Target: "I wouldn't have put that together, but on her it works." Slightly witchy. Slightly vintage. Slightly rugged. Quiet, effortless heat â€” not overtly sexy, but undeniably attractive.

STYLING RULES â€” NEVER BREAK:
1. Romantic Core + Grounding Anchor always. No exceptions.
2. Never all-soft. Never all-structured. Tension = success.
3. Build HEAD TO TOE â€” clothing + footwear + jewelry/accessories when they add something real
4. Belts are structural anchors â€” suggest when they'd ground the look
5. Reference her actual measurements when explaining fit

HEATHER'S PROFILE:
${prof}

HER CLOSET:
${closetStr||'Empty â€” say so honestly.'}

RECENT LOOK HISTORY:
${hist}

CURRENT REQUEST:
Mood: ${selMood||'not stated'}
Intent: ${selIntent||'regulate'} (regulate=calm structure without harshness | express=unexpected softness+edge | protect=grounding presence, visual armor)
Occasion: ${document.getElementById('dmOcc').value||'everyday'}

BUILD A COMPLETE HEAD-TO-TOE OUTFIT using actual pieces from her closet only.

RESPOND IN EXACTLY THIS FORMAT:

OUTFIT_NAME: [2-4 poetic words]

EXPLANATION: [2-3 sentences directly to Heather. Warm stylist voice. Why this resolves the tension, how it works on her specific body, what feeling it creates.]

PIECES:
CORE: [exact item name]
ANCHOR: [exact item name]
FOOTWEAR: [exact item name]
BELT: [exact item name or none]
JEWELRY: [up to 3 pieces separated by commas, or none]
EXTRA LAYER: [exact item name or none]

THRIFT_SUGGESTION: [One specific piece to hunt for. What outfits in her current closet it would unlock. Make it feel like a tip from someone who knows her intimately.]`;

  try{
    const res=await fetch("https://api.anthropic.com/v1/messages",{
      method:"POST",
      headers:{"Content-Type":"application/json","x-api-key":apiKey,"anthropic-version":"2023-06-01","anthropic-dangerous-direct-browser-access":"true"},
      body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:prompt}]})
    });
    const data=await res.json();
    if(data.error){throw new Error(data.error.message);}
    const text=data.content?.[0]?.text||'';
    document.getElementById('spinner').classList.remove('show');document.getElementById('dmBtn').disabled=false;
    parseOutfit(text);
  }catch(e){
    document.getElementById('spinner').classList.remove('show');document.getElementById('dmBtn').disabled=false;
    if(e.message?.includes('401')||e.message?.includes('invalid')){alert('API key issue. Tap the ðŸ”‘ key button to check your key.');showApiModal();}
    else{outfitErr();}
  }
}

function parseOutfit(text){
  const get=lbl=>{const m=text.match(new RegExp(`${lbl}:\\s*(.+)`,'i'));return m?m[1].trim():'';};
  const name=get('OUTFIT_NAME');const expl=text.match(/EXPLANATION:\s*([\s\S]*?)(?=PIECES:|$)/i)?.[1]?.trim()||'';const thrift=text.match(/THRIFT_SUGGESTION:\s*([\s\S]*?)$/i)?.[1]?.trim()||'';
  const pieces=[];
  [['CORE','Core'],['ANCHOR','Anchor'],['FOOTWEAR','Footwear'],['BELT','Belt'],['JEWELRY','Jewelry'],['EXTRA LAYER','Layer']].forEach(([key,role])=>{
    const v=get(key);if(!v||v.toLowerCase()==='none')return;
    if(key==='JEWELRY'){v.split(/[,;]/).map(x=>x.trim()).filter(x=>x&&x.toLowerCase()!=='none').forEach(x=>pieces.push({role,name:x}));}
    else pieces.push({role,name:v});
  });
  lastOutfit={name,expl,pieces,thrift};
  document.getElementById('outName').textContent=name||'Your Outfit';
  document.getElementById('outExpl').textContent=expl;
  document.getElementById('flatLay').innerHTML=pieces.map(p=>{const item=closet.find(c=>c.name.toLowerCase()===p.name.toLowerCase())||closet.find(c=>c.name.toLowerCase().includes(p.name.toLowerCase().split(' ')[0]));const ph=item?.photos?.find(x=>x);return ph?`<div class="fl-piece"><img src="${ph}" alt="${p.name}"><span>${p.role}</span></div>`:`<div class="fl-piece"><span class="fl-piece-ico">${ico(item?.cat||'')}</span><span>${p.name.split(' ').slice(0,2).join(' ')}</span><span>${p.role}</span></div>`;}).join('');
  document.getElementById('outPieces').innerHTML=pieces.map(p=>`<div class="piece-row"><span class="p-role">${p.role}</span><span class="p-name">${p.name}</span></div>`).join('');
  const tb=document.getElementById('thriftBox');
  if(thrift){tb.textContent=thrift;tb.style.display='block';if(!thriftList.some(t=>t.slice(0,40)===thrift.slice(0,40))){thriftList.push(thrift.slice(0,120));LS.set('w_thrift',thriftList);renderThrift();}}
  else{tb.style.display='none';}
  document.getElementById('outfitOut').classList.add('show');
}

function outfitErr(){document.getElementById('outName').textContent='Something went wrong';document.getElementById('outExpl').textContent='Check your connection and try again.';document.getElementById('flatLay').innerHTML='';document.getElementById('outPieces').innerHTML='';document.getElementById('thriftBox').style.display='none';document.getElementById('outfitOut').classList.add('show');}

function sendToLooks(){
  if(!lastOutfit)return;
  document.getElementById('lName').value=lastOutfit.name||'';
  document.getElementById('lItems').value=lastOutfit.pieces.map(p=>p.name).join(' + ');
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('looks').classList.add('active');
  document.querySelectorAll('.nav-btn')[3].classList.add('active');
  window.scrollTo(0,0);
}

// â”€â”€ LOOKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function logLook(){
  const name=document.getElementById('lName').value.trim();if(!name){alert('Name your look.');return;}
  const look={id:Date.now(),name,date:document.getElementById('lDate').value||new Date().toLocaleDateString(),items:document.getElementById('lItems').value,photos:['lSlot1','lSlot2'].map(id=>document.getElementById(id).dataset.img||'').filter(Boolean),wins:[...document.querySelectorAll('.rbtn.win.on')].map(b=>b.textContent.replace('âœ“ ','')),misses:[...document.querySelectorAll('.rbtn.miss.on')].map(b=>b.textContent.replace('âœ— ','')),neutral:[...document.querySelectorAll('.rbtn.neu.on')].map(b=>b.textContent.replace('~ ','')),notes:document.getElementById('lNotes').value};
  looks.unshift(look);LS.set('w_looks',looks);updateTraj();renderLooks();clearLook();
}

function clearLook(){
  ['lName','lItems','lNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('lDate').value=new Date().toLocaleDateString();
  ['lSlot1','lSlot2'].forEach(id=>{const s=document.getElementById(id);s.classList.remove('hi');delete s.dataset.img;const img=s.querySelector('img');if(img)img.remove();});
  document.querySelectorAll('.rbtn').forEach(b=>b.classList.remove('on'));
}

function renderLooks(){
  const grid=document.getElementById('looksGrid');
  if(!looks.length){grid.innerHTML=`<div class="empty"><div class="empty-ico">ðŸ“–</div><p class="empty-txt">Your style journal is empty.<br>Log your first look above.</p></div>`;return;}
  grid.innerHTML=looks.map(l=>`<div class="lcard">${l.photos?.[0]?`<img class="lcard-img" src="${l.photos[0]}" loading="lazy">`:`<div class="lcard-ph">ðŸªž</div>`}<div class="lcard-info"><div class="lcard-name">${l.name}</div><div class="lcard-date">${l.date}</div><div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-bottom:0.4rem;">${(l.wins||[]).map(t=>`<span class="rtag win">${t}</span>`).join('')}${(l.misses||[]).map(t=>`<span class="rtag miss">${t}</span>`).join('')}${(l.neutral||[]).map(t=>`<span class="rtag neu">${t}</span>`).join('')}</div>${l.notes?`<div class="lcard-notes">"${l.notes}"</div>`:''}</div></div>`).join('');
}

function updateTraj(){
  if(looks.length<3)return;
  const r=looks.slice(0,8);const aw=r.flatMap(l=>l.wins||[]);const am=r.flatMap(l=>l.misses||[]);
  let txt='';
  if(aw.filter(w=>w.includes('me')).length>=3&&aw.filter(w=>w.includes('effortless')).length>=2)txt='The instinct is working. Your best outfits feel found, not assembled. Trust it more.';
  else if(am.filter(m=>m.includes('proportion')).length>=2)txt='Proportions keep coming up. Your closet may need a stronger anchor piece.';
  else if(am.filter(m=>m.includes('try-hard')).length>=2)txt='Some looks are reading try-hard. Pull back toward quieter combinations.';
  else if(am.filter(m=>m.includes('costume')).length>=2)txt='A few looks feel too costume-y. Try breaking up matching energies with something unexpected.';
  else txt=`${looks.length} looks logged. Your style patterns are starting to emerge. Keep going.`;
  document.getElementById('trajTxt').textContent=txt;
}

// â”€â”€ WEATHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateWeather(){
  const loc=profile.location||'Utah';const sea=profile.season||'Winter';
  const c={Winter:['cold & crisp','snowy','bitter cold','clear & frozen'],Spring:['mild & breezy','unpredictable','cool mornings','rainy'],Summer:['warm & dry','hot','clear skies','afternoon storms'],Fall:['crisp & golden','cooling down','windy','jacket weather']};
  const t=(c[sea]||c.Winter)[new Date().getDay()%4];
  document.getElementById('weatherDisplay').innerHTML=`${loc.split(',')[0]}<br>${sea.toLowerCase()} â€” ${t}`;
}
</script>
</body>
</html>
